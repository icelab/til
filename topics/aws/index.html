<!DOCTYPE html><html lang="en-au"><head><meta charset="utf-8" /><meta content="width=device-width, initial-scale=1.0" name="viewport" /><meta content="Today Icelab Learned" property="og:site_name" /><meta content="http://til.icelab.com.au/topics/aws/" property="og:url" /><meta content="article" property="og:type" /><meta content="A knowledgebase of little learnings from the team at Icelab." property="og:description" /><script>!function(o){function t(n){if(e[n])return e[n].exports;var r=e[n]={exports:{},id:n,loaded:!1};return o[n].call(r.exports,r,r.exports,t),r.loaded=!0,r.exports}var e={};return t.m=o,t.c=e,t.p="",t(0)}({0:function(o,t,e){o.exports=e(12)},11:function(o,t){window.localStorage.getItem("fontsLoaded")&&(window.document.documentElement.className+=" fonts-loaded")},12:function(o,t,e){e.p="/assets/",e(11)}});</script><link href="https://til.icelab.com.au/assets/public/favicon-fe80d575.png" rel="shortcut icon" /><link href="https://til.icelab.com.au/assets/public-8b27d484.css" rel="stylesheet" type="text/css" /><link href="https://fonts.googleapis.com/css?family=Inconsolata:400,700:latin" rel="stylesheet" type="text/css" /><script async="" src="https://til.icelab.com.au/assets/public-49d86d77.js"></script><title>Today Icelab Learned about 'aws'</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', "UA-2193586-3", 'auto');
ga('send', 'pageview');</script><link href="/feed.xml" rel="alternate" title="Today Icelab Learned" type="application/atom+xml" /></head><body><aside class="sidebar" id="sidebar"><button class="close-sidebar" data-view-toggle-sidebar="">Hide topics &rsaquo; </button><div class="sidebar-topic"><a href="/topics/accessibility">accessibility</a><span class="topic-count"> (<i>2</i>)</span></div><div class="sidebar-topic"><a href="/topics/analytics">analytics</a><span class="topic-count"> (<i>1</i>)</span></div><div class="sidebar-topic"><a href="/topics/aws">aws</a><span class="topic-count"> (<i>3</i>)</span></div><div class="sidebar-topic"><a href="/topics/css">css</a><span class="topic-count"> (<i>3</i>)</span></div><div class="sidebar-topic"><a href="/topics/debugging">debugging</a><span class="topic-count"> (<i>1</i>)</span></div><div class="sidebar-topic"><a href="/topics/git">git</a><span class="topic-count"> (<i>3</i>)</span></div><div class="sidebar-topic"><a href="/topics/heroku">heroku</a><span class="topic-count"> (<i>1</i>)</span></div><div class="sidebar-topic"><a href="/topics/html">html</a><span class="topic-count"> (<i>1</i>)</span></div><div class="sidebar-topic"><a href="/topics/javascript">javascript</a><span class="topic-count"> (<i>4</i>)</span></div><div class="sidebar-topic"><a href="/topics/nginx">nginx</a><span class="topic-count"> (<i>1</i>)</span></div><div class="sidebar-topic"><a href="/topics/ops">ops</a><span class="topic-count"> (<i>2</i>)</span></div><div class="sidebar-topic"><a href="/topics/performance">performance</a><span class="topic-count"> (<i>1</i>)</span></div><div class="sidebar-topic"><a href="/topics/postgres">postgres</a><span class="topic-count"> (<i>1</i>)</span></div><div class="sidebar-topic"><a href="/topics/processing">processing</a><span class="topic-count"> (<i>1</i>)</span></div><div class="sidebar-topic"><a href="/topics/rails">rails</a><span class="topic-count"> (<i>4</i>)</span></div><div class="sidebar-topic"><a href="/topics/rake">rake</a><span class="topic-count"> (<i>1</i>)</span></div><div class="sidebar-topic"><a href="/topics/react">react</a><span class="topic-count"> (<i>2</i>)</span></div><div class="sidebar-topic"><a href="/topics/regex">regex</a><span class="topic-count"> (<i>1</i>)</span></div><div class="sidebar-topic"><a href="/topics/ruby">ruby</a><span class="topic-count"> (<i>13</i>)</span></div><div class="sidebar-topic"><a href="/topics/seo">seo</a><span class="topic-count"> (<i>1</i>)</span></div><div class="sidebar-topic"><a href="/topics/slim">slim</a><span class="topic-count"> (<i>1</i>)</span></div><div class="sidebar-topic"><a href="/topics/social">social</a><span class="topic-count"> (<i>2</i>)</span></div><div class="sidebar-topic"><a href="/topics/testing">testing</a><span class="topic-count"> (<i>1</i>)</span></div></aside><div class="header"><a class="header__logo" href="http://www.icelab.com.au"></a><a href="/" class="header__til-text">Today Icelab Learned</a><div class="topic-tag">&nbsp;about <a href="/topics/aws">aws</a></div><button class="header__view-topics open-sidebar" data-view-toggle-sidebar="">&lsaquo; <span>View</span> topics </button></div><div class="container"><div class="article"><h2 class="article__title"><a href="/creating-an-iam-user-for-s3-bucket/">Creating an IAM user for access to an S3&nbsp;bucket</a></h2><div class="article__meta">Tim Riley, 04 April 2016</div><div class="article__content" data-view-highlight=""><p>When you create an S3 bucket for a web app to use, you should create a specific IAM user to grant access to that bucket.</p>

<p>To do this, first create a user:</p>

<ol>
<li>Visit the <a href="https://console.aws.amazon.com/iam">IAM section of the AWS console</a></li>
<li>Go to the &ldquo;Users&rdquo; section and click the &ldquo;Create New Users&rdquo; button</li>
<li>Enter the user name(s) you want to create (e.g. <code>my-bucket-s3</code> for a bucket named <code>my-bucket</code>)</li>
<li>When you&rsquo;re shown the user credentials, save them somewhere safe, like our team 1Password vault</li>
<li>When you return to the IAM users list, go to the newly created user and click on their &ldquo;Permissions&rdquo; tab. Click on the &ldquo;Inline Policies&rdquo; section and create a new policy</li>
<li>Choose to create a &ldquo;Custom Policy&rdquo;</li>
<li><p>Name the policy &ldquo;my-bucket-s3-access&rdquo; (or something similarly descriptive) and paste the following into the &ldquo;Policy Document&rdquo; area (replacing <code>my-bucket</code> with your bucket&rsquo;s name):</p>
<pre class="highlight json"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"Statement"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nt">"Effect"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Allow"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"Action"</span><span class="p">:</span><span class="w"> </span><span class="s2">"s3:ListAllMyBuckets"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"Resource"</span><span class="p">:</span><span class="w"> </span><span class="s2">"arn:aws:s3:::*"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nt">"Effect"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Allow"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"Action"</span><span class="p">:</span><span class="w"> </span><span class="s2">"s3:*"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"Resource"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"arn:aws:s3:::my-bucket"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"arn:aws:s3:::my-bucket/*"</span><span class="w">
      </span><span class="p">]</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></li>
<li><p>Click &ldquo;Apply Policy&rdquo;</p></li>
</ol>

<p>The access policy should now be active and your app should be able to access the bucket with the new IAM user&rsquo;s credentials.</p>
</div><div class="article__tags"><a href="/topics/aws" class="article__tag">aws</a></div></div><div class="article"><h2 class="article__title"><a href="/cloudfront-origin-pull-with-gzip/">Using CloudFront as ‘origin pull’ (with bonus&nbsp;gzip)</a></h2><div class="article__meta">Max Wheeler, 16 February 2016</div><div class="article__content" data-view-highlight=""><p>CloudFront can act as a CDN that ‘pulls’ content from an origin server. It’s really easy to set up, you simply set the ‘Origin Domain Name’ to wherever you’re hosting your app: <code>foobar.herokuapp.com</code> for example and then &hellip; nothing. That’s all you need to do. Requests that come through CloudFront will pass through to your origin server and then be cached thereafter.</p>

<p>For bonus points it’ll also gzip your content for you without you having to do much work at all. Set ‘Compress Objects Automatically’ to ‘Yes’ and you’re done. If CloudFront can serve a gzipped version (and the client can receive one) it’ll serve up a compressed version of your file instead.</p>
</div><div class="article__tags"><a href="/topics/performance" class="article__tag">performance</a><a href="/topics/aws" class="article__tag">aws</a></div></div><div class="article"><h2 class="article__title"><a href="/aws-elasticsearch-authentication/">Authenticating with AWS&nbsp;Elasticsearch</a></h2><div class="article__meta">Andrew Croome, 21 October 2015</div><div class="article__content" data-view-highlight=""><p>The AWS Elasticseach service offers authentication via an IAM user, or by whitelisting IPs.</p>

<p>Here&rsquo;s how to use IAM credentials to sign requests to the service when using Faraday and how to hook that into the Ruby elasticsearch gem.</p>

<p>To sign requests using Faraday, you can use a gem called <a href="https://github.com/winebarrel/faraday_middleware-aws-signers-v4">faraday_middleware-aws-signers-v4</a>, which provides a middleware that will sign your requests.</p>
<pre class="highlight ruby"><code><span class="nb">require</span> <span class="s1">'faraday_middleware'</span>
<span class="nb">require</span> <span class="s1">'faraday_middleware/aws_signers_v4'</span>

<span class="n">conn</span> <span class="o">=</span> <span class="no">Faraday</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">url: </span><span class="s1">'address-of-your-AWS-es-service'</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">faraday</span><span class="o">|</span>
  <span class="n">faraday</span><span class="p">.</span><span class="nf">request</span> <span class="ss">:aws_signers_v4</span><span class="p">,</span> <span class="p">{</span>
    <span class="ss">credentials: </span><span class="no">Aws</span><span class="o">::</span><span class="no">Credentials</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="no">ENV</span><span class="p">[</span><span class="s1">'AWS_ACCESS_KEY_ID'</span><span class="p">],</span> <span class="no">ENV</span><span class="p">[</span><span class="s1">'AWS_SECRET_ACCESS_KEY'</span><span class="p">]),</span>
    <span class="ss">service_name: </span><span class="s1">'es'</span><span class="p">,</span>
    <span class="ss">region: </span><span class="s1">'ap-southeast-2'</span>
  <span class="p">}</span>

  <span class="n">faraday</span><span class="p">.</span><span class="nf">adapter</span> <span class="ss">:typhoeus</span>
<span class="k">end</span>
</code></pre>

<p>To get the client provided by the elasticsearch gem to use your Faraday configuation, you can pass that configuration to it like so:</p>
<pre class="highlight ruby"><code><span class="n">faraday_config</span> <span class="o">=</span> <span class="nb">lambda</span> <span class="k">do</span> <span class="o">|</span><span class="n">faraday</span><span class="o">|</span>
  <span class="n">faraday</span><span class="p">.</span><span class="nf">request</span> <span class="ss">:aws_signers_v4</span><span class="p">,</span> <span class="p">{</span>
    <span class="ss">credentials: </span><span class="no">Aws</span><span class="o">::</span><span class="no">Credentials</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span>
      <span class="no">ENV</span><span class="p">[</span><span class="s2">"ELASTICSEARCH_AWS_ACCESS_KEY_ID"</span><span class="p">],</span>
      <span class="no">ENV</span><span class="p">[</span><span class="s2">"ELASTICSEARCH_AWS_SECRET_ACCESS_KEY"</span><span class="p">]</span>
      <span class="p">),</span>
      <span class="ss">service_name: </span><span class="s2">"es"</span><span class="p">,</span>
      <span class="ss">region: </span><span class="no">ENV</span><span class="p">[</span><span class="s2">"ELASTICSEARCH_AWS_REGION"</span><span class="p">]</span>
    <span class="p">}</span>
    <span class="n">faraday</span><span class="p">.</span><span class="nf">adapter</span> <span class="ss">:typhoeus</span>
  <span class="k">end</span>

<span class="n">elasticsearch_host_config</span> <span class="o">=</span> <span class="p">{</span>
  <span class="ss">host:   </span><span class="no">ENV</span><span class="p">[</span><span class="s2">"ELASTICSEARCH_HOST"</span><span class="p">],</span>
  <span class="ss">port:   </span><span class="no">ENV</span><span class="p">[</span><span class="s2">"ELASTICSEARCH_PORT"</span><span class="p">],</span>
  <span class="ss">scheme: </span><span class="no">ENV</span><span class="p">[</span><span class="s2">"ELASTICSEARCH_SCHEME"</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">transport</span> <span class="o">=</span> <span class="no">Elasticsearch</span><span class="o">::</span><span class="no">Transport</span><span class="o">::</span><span class="no">Transport</span><span class="o">::</span><span class="no">HTTP</span><span class="o">::</span><span class="no">Faraday</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">hosts: </span><span class="p">[</span><span class="n">elasticsearch_host_config</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">faraday_config</span><span class="p">)</span>

<span class="n">client</span> <span class="o">=</span> <span class="no">Elasticsearch</span><span class="o">::</span><span class="no">Client</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">transport: </span><span class="n">transport</span><span class="p">)</span>
</code></pre>

<p>You can then use the client object as usual, and you&rsquo;ll get automatically signed requests.</p>
</div><div class="article__tags"><a href="/topics/ruby" class="article__tag">ruby</a><a href="/topics/aws" class="article__tag">aws</a></div></div><div class="pagination"></div></div><div class="footer">A knowledgebase of little learnings from the team at Icelab. <a href="https://github.com/icelab/til/">Source on GitHub</a>.</div><script>!function(t){function e(i){if(n[i])return n[i].exports;var o=n[i]={exports:{},id:i,loaded:!1};return t[i].call(o.exports,o,o.exports,e),o.loaded=!0,o.exports}var n={};return e.m=t,e.c=n,e.p="",e(0)}([function(t,e,n){t.exports=n(10)},,,,,,,function(t,e){!function(){function e(t,e){r?t.addEventListener("scroll",e,!1):t.attachEvent("scroll",e)}function n(t){document.body?t():r?document.addEventListener("DOMContentLoaded",t):document.attachEvent("onreadystatechange",function(){"interactive"!=document.readyState&&"complete"!=document.readyState||t()})}function i(t){this.a=document.createElement("div"),this.a.setAttribute("aria-hidden","true"),this.a.appendChild(document.createTextNode(t)),this.b=document.createElement("span"),this.c=document.createElement("span"),this.h=document.createElement("span"),this.f=document.createElement("span"),this.g=-1,this.b.style.cssText="max-width:none;display:inline-block;position:absolute;height:100%;width:100%;overflow:scroll;font-size:16px;",this.c.style.cssText="max-width:none;display:inline-block;position:absolute;height:100%;width:100%;overflow:scroll;font-size:16px;",this.f.style.cssText="max-width:none;display:inline-block;position:absolute;height:100%;width:100%;overflow:scroll;font-size:16px;",this.h.style.cssText="display:inline-block;width:200%;height:200%;font-size:16px;max-width:none;",this.b.appendChild(this.h),this.c.appendChild(this.f),this.a.appendChild(this.b),this.a.appendChild(this.c)}function o(t,e){t.a.style.cssText="max-width:none;min-width:20px;min-height:20px;display:inline-block;overflow:hidden;position:absolute;width:auto;margin:0;padding:0;top:-999px;left:-999px;white-space:nowrap;font:"+e+";"}function a(t){var e=t.a.offsetWidth,n=e+100;return t.f.style.width=n+"px",t.c.scrollLeft=n,t.b.scrollLeft=t.b.scrollWidth+100,t.g!==e?(t.g=e,!0):!1}function l(t,n){function i(){var t=o;a(t)&&null!==t.a.parentNode&&n(t.g)}var o=t;e(t.b,i),e(t.c,i),a(t)}function s(t,e){var n=e||{};this.family=t,this.style=n.style||"normal",this.weight=n.weight||"normal",this.stretch=n.stretch||"normal"}function c(){if(null===f){var t=document.createElement("div");try{t.style.font="condensed 100px sans-serif"}catch(e){}f=""!==t.style.font}return f}function d(t,e){return[t.style,t.weight,c()?t.stretch:"","100px",e].join(" ")}var r=!!document.addEventListener,h=null,f=null,m=!!window.FontFace;s.prototype.load=function(t,e){var a=this,s=t||"BESbswy",c=e||3e3,r=(new Date).getTime();return new Promise(function(t,e){if(m){var f=new Promise(function(t,e){function n(){(new Date).getTime()-r>=c?e():document.fonts.load(d(a,a.family),s).then(function(e){1<=e.length?t():setTimeout(n,25)},function(){e()})}n()}),u=new Promise(function(t,e){setTimeout(e,c)});Promise.race([u,f]).then(function(){t(a)},function(){e(a)})}else n(function(){function n(){var e;(e=-1!=w&&-1!=y||-1!=w&&-1!=v||-1!=y&&-1!=v)&&((e=w!=y&&w!=v&&y!=v)||(null===h&&(e=/AppleWebKit\/([0-9]+)(?:\.([0-9]+))/.exec(window.navigator.userAgent),h=!!e&&(536>parseInt(e[1],10)||536===parseInt(e[1],10)&&11>=parseInt(e[2],10))),e=h&&(w==g&&y==g&&v==g||w==x&&y==x&&v==x||w==b&&y==b&&v==b)),e=!e),e&&(null!==T.parentNode&&T.parentNode.removeChild(T),clearTimeout(E),t(a))}function f(){if((new Date).getTime()-r>=c)null!==T.parentNode&&T.parentNode.removeChild(T),e(a);else{var t=document.hidden;!0!==t&&void 0!==t||(w=m.a.offsetWidth,y=u.a.offsetWidth,v=p.a.offsetWidth,n()),E=setTimeout(f,50)}}var m=new i(s),u=new i(s),p=new i(s),w=-1,y=-1,v=-1,g=-1,x=-1,b=-1,T=document.createElement("div"),E=0;T.dir="ltr",o(m,d(a,"sans-serif")),o(u,d(a,"serif")),o(p,d(a,"monospace")),T.appendChild(m.a),T.appendChild(u.a),T.appendChild(p.a),document.body.appendChild(T),g=m.a.offsetWidth,x=u.a.offsetWidth,b=p.a.offsetWidth,f(),l(m,function(t){w=t,n()}),o(m,d(a,'"'+a.family+'",sans-serif')),l(u,function(t){y=t,n()}),o(u,d(a,'"'+a.family+'",serif')),l(p,function(t){v=t,n()}),o(p,d(a,'"'+a.family+'",monospace'))})})},window.FontFaceObserver=s,window.FontFaceObserver.prototype.check=window.FontFaceObserver.prototype.load=s.prototype.load,"undefined"!=typeof t&&(t.exports=window.FontFaceObserver)}()},,function(t,e,n){function i(t){var e=window.localStorage.getItem("fontsLoaded");if(!e){var n=[];t.forEach(function(t){var e=new window.FontFaceObserver(t.family,{weight:t.weight,style:t.style});n.push(e.check())}),Promise.all(n).then(function(){window.document.documentElement.className+=" fonts-loaded",window.localStorage.setItem("fontsLoaded",!0)})}}n(7);var o=[{family:"National",style:"normal",weight:"normal"},{family:"National",style:"italic",weight:"normal"},{family:"National",style:"italic",weight:"bold"},{family:"National",style:"italic",weight:"bold"},{family:"TiemposText",style:"normal",weight:"normal"},{family:"TiemposText",style:"italic",weight:"normal"},{family:"TiemposText",style:"italic",weight:"bold"},{family:"TiemposText",style:"italic",weight:"bold"},{family:"Inconsolata",style:"normal",weight:"400"},{family:"Inconsolata",style:"italic",weight:"400"}];i(o)},function(t,e,n){n.p="/assets/",n(9)}]);</script></body></html>