<!DOCTYPE html><html lang="en-au"><head><meta charset="utf-8" /><meta content="width=device-width, initial-scale=1.0" name="viewport" /><meta content="Today Icelab Learned" property="og:site_name" /><meta content="http://til.icelab.com.au/topics/ruby/" property="og:url" /><meta content="article" property="og:type" /><meta content="A knowledgebase of little learnings from the team at Icelab." property="og:description" /><script>!function(o){function t(n){if(e[n])return e[n].exports;var r=e[n]={exports:{},id:n,loaded:!1};return o[n].call(r.exports,r,r.exports,t),r.loaded=!0,r.exports}var e={};return t.m=o,t.c=e,t.p="",t(0)}({0:function(o,t,e){o.exports=e(12)},11:function(o,t){window.localStorage.getItem("fontsLoaded")&&(window.document.documentElement.className+=" fonts-loaded")},12:function(o,t,e){e.p="/assets/",e(11)}});</script><link href="https://til.icelab.com.au/assets/public/favicon-fe80d575.png" rel="shortcut icon" /><link href="https://til.icelab.com.au/assets/public-8b27d484.css" rel="stylesheet" type="text/css" /><link href="https://fonts.googleapis.com/css?family=Inconsolata:400,700:latin" rel="stylesheet" type="text/css" /><script async="" src="https://til.icelab.com.au/assets/public-49d86d77.js"></script><title>Today Icelab Learned about 'ruby'</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', "UA-2193586-3", 'auto');
ga('send', 'pageview');</script><link href="/feed.xml" rel="alternate" title="Today Icelab Learned" type="application/atom+xml" /></head><body><aside class="sidebar" id="sidebar"><button class="close-sidebar" data-view-toggle-sidebar="">Hide topics &rsaquo; </button><div class="sidebar-topic"><a href="/topics/accessibility">accessibility</a><span class="topic-count"> (<i>2</i>)</span></div><div class="sidebar-topic"><a href="/topics/analytics">analytics</a><span class="topic-count"> (<i>1</i>)</span></div><div class="sidebar-topic"><a href="/topics/aws">aws</a><span class="topic-count"> (<i>3</i>)</span></div><div class="sidebar-topic"><a href="/topics/css">css</a><span class="topic-count"> (<i>3</i>)</span></div><div class="sidebar-topic"><a href="/topics/debugging">debugging</a><span class="topic-count"> (<i>1</i>)</span></div><div class="sidebar-topic"><a href="/topics/git">git</a><span class="topic-count"> (<i>3</i>)</span></div><div class="sidebar-topic"><a href="/topics/heroku">heroku</a><span class="topic-count"> (<i>1</i>)</span></div><div class="sidebar-topic"><a href="/topics/html">html</a><span class="topic-count"> (<i>1</i>)</span></div><div class="sidebar-topic"><a href="/topics/javascript">javascript</a><span class="topic-count"> (<i>4</i>)</span></div><div class="sidebar-topic"><a href="/topics/nginx">nginx</a><span class="topic-count"> (<i>1</i>)</span></div><div class="sidebar-topic"><a href="/topics/ops">ops</a><span class="topic-count"> (<i>2</i>)</span></div><div class="sidebar-topic"><a href="/topics/performance">performance</a><span class="topic-count"> (<i>1</i>)</span></div><div class="sidebar-topic"><a href="/topics/postgres">postgres</a><span class="topic-count"> (<i>1</i>)</span></div><div class="sidebar-topic"><a href="/topics/processing">processing</a><span class="topic-count"> (<i>1</i>)</span></div><div class="sidebar-topic"><a href="/topics/rails">rails</a><span class="topic-count"> (<i>4</i>)</span></div><div class="sidebar-topic"><a href="/topics/rake">rake</a><span class="topic-count"> (<i>1</i>)</span></div><div class="sidebar-topic"><a href="/topics/react">react</a><span class="topic-count"> (<i>2</i>)</span></div><div class="sidebar-topic"><a href="/topics/regex">regex</a><span class="topic-count"> (<i>1</i>)</span></div><div class="sidebar-topic"><a href="/topics/ruby">ruby</a><span class="topic-count"> (<i>13</i>)</span></div><div class="sidebar-topic"><a href="/topics/seo">seo</a><span class="topic-count"> (<i>1</i>)</span></div><div class="sidebar-topic"><a href="/topics/slim">slim</a><span class="topic-count"> (<i>1</i>)</span></div><div class="sidebar-topic"><a href="/topics/social">social</a><span class="topic-count"> (<i>2</i>)</span></div><div class="sidebar-topic"><a href="/topics/testing">testing</a><span class="topic-count"> (<i>1</i>)</span></div></aside><div class="header"><a class="header__logo" href="http://www.icelab.com.au"></a><a href="/" class="header__til-text">Today Icelab Learned</a><div class="topic-tag">&nbsp;about <a href="/topics/ruby">ruby</a></div><button class="header__view-topics open-sidebar" data-view-toggle-sidebar="">&lsaquo; <span>View</span> topics </button></div><div class="container"><div class="article"><h2 class="article__title"><a href="/rake-tasks-with-splat-arguments/">Rake tasks with splat&nbsp;arguments</a></h2><div class="article__meta">Tim Riley, 03 May 2017</div><div class="article__content" data-view-highlight=""><p>Splat arguments can be helpful, and it turns out we don&rsquo;t need to forsake them when we&rsquo;re building Rake tasks, either.</p>

<p>Let&rsquo;s say we want to build an <code>elasticsearch:reindex</code> task that allows an optional list of entity types to reindex:</p>
<pre class="highlight ruby"><code><span class="n">namespace</span> <span class="ss">:elasticsearch</span> <span class="k">do</span>
  <span class="n">task</span> <span class="ss">:reindex</span> <span class="k">do</span> <span class="o">|</span><span class="n">_t</span><span class="p">,</span> <span class="n">args</span><span class="o">|</span>
    <span class="no">Search</span><span class="o">::</span><span class="no">Container</span><span class="p">[</span><span class="s2">"search.operations.enqueue_reindex"</span><span class="p">]</span><span class="o">.</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">.</span><span class="nf">extras</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p>Rake gives us a <a href="http://www.rubydoc.info/gems/rake/Rake/TaskArguments#extras-instance_method"><code>TaskArguments#extras</code></a> method, which returns  the values not associated with any of the task&rsquo;s named arguments.</p>

<p>So now we can call our rake task like so:</p>
<pre class="highlight plaintext"><code>rake elasticsearch:reindex[products, posts]
</code></pre>

<p>And <code>args.extras</code> gives us this:</p>
<pre class="highlight ruby"><code><span class="p">[</span><span class="s2">"products"</span><span class="p">,</span> <span class="s2">"posts"</span><span class="p">]</span>
</code></pre>
</div><div class="article__tags"><a href="/topics/ruby" class="article__tag">ruby</a><a href="/topics/rake" class="article__tag">rake</a></div></div><div class="article"><h2 class="article__title"><a href="/kwarg-splat-arguments-create-new-hashes/">Kwarg splat arguments create new&nbsp;hashes</a></h2><div class="article__meta">Tim Rilety, 03 May 2017</div><div class="article__content" data-view-highlight=""><p>I made a method with a &ldquo;double splat&rdquo; kwarg argument to accept some options and returned a modified hash:</p>
<pre class="highlight ruby"><code><span class="k">def</span> <span class="nf">singularize_options</span><span class="p">(</span><span class="o">**</span><span class="n">options</span><span class="p">)</span>
  <span class="n">options</span> <span class="o">=</span> <span class="n">options</span><span class="p">.</span><span class="nf">dup</span>

  <span class="c1"># mutate `options` here...</span>

  <span class="n">options</span>
<span class="k">end</span>
</code></pre>

<p>In my usual &ldquo;don&rsquo;t mutate things we don&rsquo;t own&rdquo; style, I <code>#dup</code>ed the incoming options before going to work on it.</p>

<p>However, <a href="https://github.com/dry-rb/dry-view/pull/36/files#r114222945">thanks to our dry-rb/rom-rb friend @flash-gordon</a>, I learnt this wasn&rsquo;t necessary! As he says:</p>

<blockquote>
<p>when you capture values with <code>**</code>, Ruby creates a new hash instance so calling <code>.dup</code> is not needed</p>
</blockquote>
<pre class="highlight ruby"><code><span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="o">**</span><span class="n">options</span><span class="p">)</span>
  <span class="n">options</span><span class="p">.</span><span class="nf">object_id</span>
<span class="k">end</span>

<span class="p">{}.</span><span class="nf">tap</span> <span class="p">{</span> <span class="o">|</span><span class="n">h</span><span class="o">|</span> <span class="nb">puts</span> <span class="n">foo</span><span class="p">(</span><span class="n">h</span><span class="p">)</span> <span class="o">==</span> <span class="n">h</span><span class="p">.</span><span class="nf">object_id</span> <span class="p">}</span>
<span class="c1"># =&gt; false</span>
</code></pre>

<p>Now my method can be even simpler:</p>
<pre class="highlight ruby"><code><span class="k">def</span> <span class="nf">singularize_options</span><span class="p">(</span><span class="o">**</span><span class="n">options</span><span class="p">)</span>
  <span class="c1"># mutate `options` here...</span>
  <span class="n">options</span>
<span class="k">end</span>
</code></pre>
</div><div class="article__tags"><a href="/topics/ruby" class="article__tag">ruby</a></div></div><div class="article"><h2 class="article__title"><a href="/specify-enumerator-index-offset/">Specify enumerator index&nbsp;offset</a></h2><div class="article__meta">Daniel Nitsikopoulos, 09 June 2016</div><div class="article__content" data-view-highlight=""><p>When looping through a collection of items, we sometimes want access to the index of an item at each iteration.</p>

<p>We can do that with <code>collection.each_with_index{ |item, index| ... }</code>.</p>

<p>In this case, <code>index</code> will always start at <code>0</code>. </p>

<p>If we want index to start from a particular number, we can use <code>Enumerator#with_index</code> and specify an offset.</p>

<p>For example: <code>collection.each.with_index(1){ |item, index| ... }</code>.</p>

<p><a href="http://ruby-doc.org/core-2.1.0/Enumerator.html#method-i-with_index">Enumerator#with_index</a></p>
</div><div class="article__tags"><a href="/topics/ruby" class="article__tag">ruby</a></div></div><div class="article"><h2 class="article__title"><a href="/uri-regex-ruby/">URI regular&nbsp;expressions</a></h2><div class="article__meta">Daniel Nitsikopoulos, 01 June 2016</div><div class="article__content" data-view-highlight=""><p>Let&rsquo;s go ahead and write some regex to validate a URI in Ruby:</p>

<p><img src="http://vignette3.wikia.nocookie.net/arresteddevelopment/images/e/ef/2x04_Good_Grief_%2832%29.png/revision/latest/scale-to-width-down/640?cb=20121126044547" alt="Good Grief" /></p>
<pre class="highlight ruby"><code><span class="no">URI</span><span class="p">.</span><span class="nf">regexp</span>
</code></pre>

<p>That&rsquo;s it!</p>

<p>We can use it like so</p>
<pre class="highlight ruby"><code><span class="no">URI</span><span class="p">.</span><span class="nf">regexp</span><span class="p">.</span><span class="nf">match</span><span class="p">(</span><span class="n">my_uri</span><span class="p">)</span>
</code></pre>

<p>If you have a look at the output of <code>URI.regexp</code> in <code>irb</code>, you&rsquo;ll see the pattern that&rsquo;s used to match against. It&rsquo;s relatively complex, but each capture group is documented.</p>

<ol>
<li>Scheme</li>
<li>Opaque (e.g. scheme:foo/bar)</li>
<li>User Info</li>
<li>Host</li>
<li>Port</li>
<li>Registry</li>
<li>Path</li>
<li>Query</li>
<li>Fragment</li>
</ol>
<pre class="highlight ruby"><code><span class="n">irb</span><span class="p">(</span><span class="n">main</span><span class="p">):</span><span class="mo">001</span><span class="p">:</span><span class="mi">0</span><span class="o">&gt;</span> <span class="no">URI</span><span class="p">.</span><span class="nf">regexp</span><span class="p">.</span><span class="nf">match</span><span class="p">(</span><span class="s2">"http://username:password@foo.bar:80/baz.html?query=string#fragment"</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="c1">#&lt;MatchData "http://username:password@foo.bar:80/baz.html?query=string#frag" 1:"http" 2:nil 3:"username:password" 4:"foo.bar" 5:"80" 6:nil 7:"/baz.html" 8:"query=string" 9:"frag"&gt;</span>
</code></pre>
</div><div class="article__tags"><a href="/topics/regex" class="article__tag">regex</a><a href="/topics/ruby" class="article__tag">ruby</a></div></div><div class="article"><h2 class="article__title"><a href="/hash-new-with-a-block-works-well-as-a-keyed-cache/">Hash.new with a block works well as a keyed&nbsp;cache</a></h2><div class="article__meta">Tim Riley, 23 May 2016</div><div class="article__content" data-view-highlight=""><p>We&rsquo;re all familiar with the <code>@foo ||= expensive_computation</code> technique to memoize (i.e. cache) the output of slow computations or to avoid unnecessary object creation.</p>

<p>If you want to do the same but with results that will vary by a single parameter, you can use Ruby&rsquo;s hash with its <a href="http://ruby-doc.org/core-2.3.1/Hash.html#method-c-new">block-based initializer</a> to handle the caching for you:</p>
<pre class="highlight ruby"><code><span class="k">def</span> <span class="nf">my_cache</span>
  <span class="vi">@my_cache</span> <span class="o">||=</span> <span class="no">Hash</span><span class="p">.</span><span class="nf">new</span> <span class="k">do</span> <span class="o">|</span><span class="nb">hash</span><span class="p">,</span> <span class="n">key</span><span class="o">|</span>
    <span class="nb">hash</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">some_slow_computation</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># Computed once</span>
<span class="n">my_cache</span><span class="p">[</span><span class="ss">:foo</span><span class="p">]</span>

<span class="c1"># Then cached</span>
<span class="n">my_cache</span><span class="p">[</span><span class="ss">:foo</span><span class="p">]</span>
</code></pre>

<p>You can see this work in practice <a href="https://github.com/dry-rb/dry-component/blob/0bebc656b625a18c25e3c8d9c4b71946fecac5e1/lib/dry/component/injector.rb#L56-L60">inside dry-component&rsquo;s Injector</a>, where it caches objects to allow arbitrarily long chaining of injector strategies without creating duplicate injector objects.</p>
</div><div class="article__tags"><a href="/topics/ruby" class="article__tag">ruby</a></div></div><div class="article"><h2 class="article__title"><a href="/symbolize-keys/">Symbolize&nbsp;keys</a></h2><div class="article__meta">Jojo Hall, 19 November 2015</div><div class="article__content" data-view-highlight=""><p>If you&rsquo;re writing plain old Ruby you can symbolize the keys of a hash with the following:</p>
<pre class="highlight ruby"><code><span class="nb">hash</span><span class="p">.</span><span class="nf">inject</span><span class="p">({}){</span><span class="o">|</span><span class="n">memo</span><span class="p">,(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span><span class="o">|</span> <span class="n">memo</span><span class="p">[</span><span class="n">k</span><span class="p">.</span><span class="nf">to_sym</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span> <span class="n">memo</span><span class="p">}</span>
</code></pre>

<p>This does the following:</p>
<pre class="highlight ruby"><code><span class="nb">hash</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"hello"</span> <span class="o">=&gt;</span> <span class="s2">"jojo"</span><span class="p">}</span>
<span class="nb">hash</span><span class="p">.</span><span class="nf">inject</span><span class="p">({}){</span><span class="o">|</span><span class="n">memo</span><span class="p">,(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span><span class="o">|</span> <span class="n">memo</span><span class="p">[</span><span class="n">k</span><span class="p">.</span><span class="nf">to_sym</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span> <span class="n">memo</span><span class="p">}</span>
<span class="o">=&gt;</span> <span class="p">{</span><span class="ss">:hello</span><span class="o">=&gt;</span><span class="s2">"jojo"</span><span class="p">}</span>
</code></pre>

<p>However if you&rsquo;re doing this in a web application you may want to make a module to make hash and array data transformations easily available to you. In most of our apps we would use <a href="https://github.com/solnic/transproc">transproc</a> to help us with this — if you&rsquo;re working in one of Icelab&rsquo;s Rodakase apps this will be available to you.</p>
<pre class="highlight ruby"><code><span class="nb">require</span> <span class="s2">"transproc/all"</span>

<span class="k">module</span> <span class="nn">Functions</span>
  <span class="kp">extend</span> <span class="no">Transproc</span><span class="o">::</span><span class="no">Registry</span>

  <span class="n">import</span> <span class="no">Transproc</span><span class="o">::</span><span class="no">HashTransformations</span>
  <span class="n">import</span> <span class="no">Transproc</span><span class="o">::</span><span class="no">ArrayTransformations</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">t</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="nb">self</span><span class="p">[</span><span class="o">*</span><span class="n">args</span><span class="p">]</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">Functions</span><span class="p">.</span><span class="nf">t</span><span class="p">(</span><span class="ss">:symbolize_keys</span><span class="p">)[{</span><span class="s2">"foo"</span> <span class="o">=&gt;</span> <span class="s2">"bar"</span><span class="p">}]</span>
<span class="c1"># =&gt; {foo: "bar"}</span>
</code></pre>

<p>If you are using Rails then you can use the method <code>hash.symbolize_keys</code> or the destructive version <code>hash.symbolize_keys!</code><br>
(both made available via ActiveSupport).</p>
</div><div class="article__tags"><a href="/topics/ruby" class="article__tag">ruby</a></div></div><div class="article"><h2 class="article__title"><a href="/pry-is-amazing/">Pry is&nbsp;amazing</a></h2><div class="article__meta">Tim Riley, 11 November 2015</div><div class="article__content" data-view-highlight=""><p><a href="https://github.com/pry/pry">Pry</a> is amazing! It has a whole bunch of helpful shortcuts you can use while working in a session.</p>

<p>I found the <a href="https://github.com/pry/pry/wiki/Exceptions">exception handling shortcuts</a> particularly helpful. <code>_ex_</code> will give you the last raised exception, and <code>wtf?</code> will show you a stacktrace from that exception (which is helpful, since stacktraces aren&rsquo;t normally shown in interactive terminal sessions like this). Hilariously, you can add more question marks or exclamation marks on the end to see more detail.</p>

<p>If you work with Ruby app consoles regularly, you&rsquo;d do yourself a favour to give the <a href="https://github.com/pry/pry/wiki">Pry Wiki</a> a good read!</p>
</div><div class="article__tags"><a href="/topics/ruby" class="article__tag">ruby</a><a href="/topics/debugging" class="article__tag">debugging</a></div></div><div class="article"><h2 class="article__title"><a href="/aws-elasticsearch-authentication/">Authenticating with AWS&nbsp;Elasticsearch</a></h2><div class="article__meta">Andrew Croome, 21 October 2015</div><div class="article__content" data-view-highlight=""><p>The AWS Elasticseach service offers authentication via an IAM user, or by whitelisting IPs.</p>

<p>Here&rsquo;s how to use IAM credentials to sign requests to the service when using Faraday and how to hook that into the Ruby elasticsearch gem.</p>

<p>To sign requests using Faraday, you can use a gem called <a href="https://github.com/winebarrel/faraday_middleware-aws-signers-v4">faraday_middleware-aws-signers-v4</a>, which provides a middleware that will sign your requests.</p>
<pre class="highlight ruby"><code><span class="nb">require</span> <span class="s1">'faraday_middleware'</span>
<span class="nb">require</span> <span class="s1">'faraday_middleware/aws_signers_v4'</span>

<span class="n">conn</span> <span class="o">=</span> <span class="no">Faraday</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">url: </span><span class="s1">'address-of-your-AWS-es-service'</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">faraday</span><span class="o">|</span>
  <span class="n">faraday</span><span class="p">.</span><span class="nf">request</span> <span class="ss">:aws_signers_v4</span><span class="p">,</span> <span class="p">{</span>
    <span class="ss">credentials: </span><span class="no">Aws</span><span class="o">::</span><span class="no">Credentials</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="no">ENV</span><span class="p">[</span><span class="s1">'AWS_ACCESS_KEY_ID'</span><span class="p">],</span> <span class="no">ENV</span><span class="p">[</span><span class="s1">'AWS_SECRET_ACCESS_KEY'</span><span class="p">]),</span>
    <span class="ss">service_name: </span><span class="s1">'es'</span><span class="p">,</span>
    <span class="ss">region: </span><span class="s1">'ap-southeast-2'</span>
  <span class="p">}</span>

  <span class="n">faraday</span><span class="p">.</span><span class="nf">adapter</span> <span class="ss">:typhoeus</span>
<span class="k">end</span>
</code></pre>

<p>To get the client provided by the elasticsearch gem to use your Faraday configuation, you can pass that configuration to it like so:</p>
<pre class="highlight ruby"><code><span class="n">faraday_config</span> <span class="o">=</span> <span class="nb">lambda</span> <span class="k">do</span> <span class="o">|</span><span class="n">faraday</span><span class="o">|</span>
  <span class="n">faraday</span><span class="p">.</span><span class="nf">request</span> <span class="ss">:aws_signers_v4</span><span class="p">,</span> <span class="p">{</span>
    <span class="ss">credentials: </span><span class="no">Aws</span><span class="o">::</span><span class="no">Credentials</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span>
      <span class="no">ENV</span><span class="p">[</span><span class="s2">"ELASTICSEARCH_AWS_ACCESS_KEY_ID"</span><span class="p">],</span>
      <span class="no">ENV</span><span class="p">[</span><span class="s2">"ELASTICSEARCH_AWS_SECRET_ACCESS_KEY"</span><span class="p">]</span>
      <span class="p">),</span>
      <span class="ss">service_name: </span><span class="s2">"es"</span><span class="p">,</span>
      <span class="ss">region: </span><span class="no">ENV</span><span class="p">[</span><span class="s2">"ELASTICSEARCH_AWS_REGION"</span><span class="p">]</span>
    <span class="p">}</span>
    <span class="n">faraday</span><span class="p">.</span><span class="nf">adapter</span> <span class="ss">:typhoeus</span>
  <span class="k">end</span>

<span class="n">elasticsearch_host_config</span> <span class="o">=</span> <span class="p">{</span>
  <span class="ss">host:   </span><span class="no">ENV</span><span class="p">[</span><span class="s2">"ELASTICSEARCH_HOST"</span><span class="p">],</span>
  <span class="ss">port:   </span><span class="no">ENV</span><span class="p">[</span><span class="s2">"ELASTICSEARCH_PORT"</span><span class="p">],</span>
  <span class="ss">scheme: </span><span class="no">ENV</span><span class="p">[</span><span class="s2">"ELASTICSEARCH_SCHEME"</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">transport</span> <span class="o">=</span> <span class="no">Elasticsearch</span><span class="o">::</span><span class="no">Transport</span><span class="o">::</span><span class="no">Transport</span><span class="o">::</span><span class="no">HTTP</span><span class="o">::</span><span class="no">Faraday</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">hosts: </span><span class="p">[</span><span class="n">elasticsearch_host_config</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">faraday_config</span><span class="p">)</span>

<span class="n">client</span> <span class="o">=</span> <span class="no">Elasticsearch</span><span class="o">::</span><span class="no">Client</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">transport: </span><span class="n">transport</span><span class="p">)</span>
</code></pre>

<p>You can then use the client object as usual, and you&rsquo;ll get automatically signed requests.</p>
</div><div class="article__tags"><a href="/topics/ruby" class="article__tag">ruby</a><a href="/topics/aws" class="article__tag">aws</a></div></div><div class="article"><h2 class="article__title"><a href="/manually-incrementing-count-columns/">Manually incrementing count columns in&nbsp;rails</a></h2><div class="article__meta">Daniel Nitsikopoulos, 18 September 2015</div><div class="article__content" data-view-highlight=""><p>Adding a counter cache column to a model is a common optimisation we make in order to avoid unnecessary queries when trying to aggregate data associated with that particular model. Rails provides us with a number of ways to maintain the counter cache column&rsquo;s value. The first is to follow the rails convention and add <code>counter_cache: true</code> to a <code>belongs_to</code> association and ensure we have a correctly named <code>*_count</code> column.</p>

<p>The other way to do it, is manually. In this case rails provides us with a few convenience methods to increment a given column.</p>

<p>The first is <code>ActiveRecord::Base#increment!(attribute, by)</code>.</p>

<p><code>increment!</code> is defined as:</p>
<pre class="highlight ruby"><code><span class="k">def</span> <span class="nf">increment!</span><span class="p">(</span><span class="n">attribute</span><span class="p">,</span> <span class="n">by</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
  <span class="n">increment</span><span class="p">(</span><span class="n">attribute</span><span class="p">,</span> <span class="n">by</span><span class="p">).</span><span class="nf">update_attribute</span><span class="p">(</span><span class="n">attribute</span><span class="p">,</span> <span class="nb">self</span><span class="p">[</span><span class="n">attribute</span><span class="p">])</span>
<span class="k">end</span>
</code></pre>

<p>and <code>increment</code> is defined as:</p>
<pre class="highlight ruby"><code><span class="k">def</span> <span class="nf">increment</span><span class="p">(</span><span class="n">attribute</span><span class="p">,</span> <span class="n">by</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
  <span class="nb">self</span><span class="p">[</span><span class="n">attribute</span><span class="p">]</span> <span class="o">||=</span> <span class="mi">0</span>
  <span class="nb">self</span><span class="p">[</span><span class="n">attribute</span><span class="p">]</span> <span class="o">+=</span> <span class="n">by</span>
  <span class="nb">self</span>
<span class="k">end</span>
</code></pre>

<p>Which means that we&rsquo;re first fetching the current attribute&rsquo;s value, incrementing it then passing it on to <code>update_attribute</code> before it can be saved. This method leads to a non-atomic database operation, that is to say that at one point, the count is different in memory than it is in the database (which can lead to race conditions).</p>

<p>The second is <code>ActiveRecord::Base#increment_counter(column_name, record_id)</code></p>

<p><code>increment_counter</code> is defined as:</p>
<pre class="highlight ruby"><code><span class="k">def</span> <span class="nf">increment_counter</span><span class="p">(</span><span class="n">counter_name</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
  <span class="n">update_counters</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">counter_name</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">)</span>
<span class="k">end</span>
</code></pre>

<p>which executes SQL like:</p>
<pre class="highlight sql"><code><span class="k">UPDATE</span> <span class="nv">"table_name"</span>
  <span class="k">SET</span> <span class="nv">"counter_name"</span> <span class="o">=</span> <span class="nv">"counter_name"</span> <span class="o">+</span> <span class="mi">1</span>
  <span class="k">WHERE</span> <span class="n">id</span> <span class="o">=</span> <span class="mi">1</span>
</code></pre>

<p>This means that we now have an atomic operation and the counter cache value is the same across the system.</p>

<p>Docs:</p>

<ul>
<li><a href="http://apidock.com/rails/ActiveRecord/Base/increment!">increment!</a></li>
<li><a href="http://apidock.com/rails/ActiveRecord/Base/increment_counter/class">increment_counter</a></li>
</ul>
</div><div class="article__tags"><a href="/topics/rails" class="article__tag">rails</a><a href="/topics/ruby" class="article__tag">ruby</a></div></div><div class="article"><h2 class="article__title"><a href="/displaying-booleans-in-active-admin/">Displaying booleans in Active&nbsp;Admin</a></h2><div class="article__meta">Jojo Hall, 13 August 2015</div><div class="article__content" data-view-highlight=""><p>In Active Admin if you want to display a boolean property that doesn&rsquo;t directly map to a database column you can use <code>status_tag</code> to display the value in a friendly way:</p>
<pre class="highlight ruby"><code><span class="n">column</span> <span class="ss">:featured</span> <span class="k">do</span> <span class="o">|</span><span class="n">thing</span><span class="o">|</span>
  <span class="n">thing</span><span class="p">.</span><span class="nf">featured?</span> <span class="p">?</span> <span class="n">status_tag</span><span class="p">(</span><span class="s2">"yes"</span><span class="p">,</span> <span class="ss">:ok</span><span class="p">)</span> <span class="p">:</span> <span class="n">status_tag</span><span class="p">(</span><span class="s2">"no"</span><span class="p">)</span>
<span class="k">end</span>
</code></pre>

<p>There&rsquo;s a bit more info in the <em><a href="http://activeadmin.info/docs/12-arbre-components.html#status-tag">Active Admin docs</a></em> which shows you how to add classes too!</p>
</div><div class="article__tags"><a href="/topics/rails" class="article__tag">rails</a><a href="/topics/ruby" class="article__tag">ruby</a></div></div><div class="article"><h2 class="article__title"><a href="/string-format/">Formatting strings with C-like formatting&nbsp;codes.</a></h2><div class="article__meta">Daniel Nitsikopoulos, 12 August 2015</div><div class="article__content" data-view-highlight=""><p>I learnt this while putting together the report emails for Ticketscout.</p>

<p>Most of the time, regular string interpolation is all that we need when working with strings. Though sometimes we want a little more control over the formatting.</p>

<p>Let&rsquo;s say we have a set of numbers that we want to calculate the average for, then print that average to 1 decimal place.</p>
<pre class="highlight ruby"><code><span class="no">FLOATS</span> <span class="o">=</span> <span class="p">[</span>
  <span class="mi">42</span><span class="o">.</span><span class="mi">0</span><span class="p">,</span>
  <span class="mi">36</span><span class="o">.</span><span class="mi">0</span><span class="p">,</span>
  <span class="mi">28</span><span class="o">.</span><span class="mi">0</span><span class="p">,</span>
  <span class="mi">19</span><span class="o">.</span><span class="mi">0</span><span class="p">,</span>
  <span class="mi">27</span><span class="o">.</span><span class="mi">0</span><span class="p">,</span>
  <span class="mi">18</span><span class="o">.</span><span class="mi">0</span><span class="p">,</span>
  <span class="mi">10</span><span class="o">.</span><span class="mi">0</span>
<span class="p">]</span>
<span class="n">avg</span> <span class="o">=</span> <span class="no">FLOATS</span><span class="p">.</span><span class="nf">reduce</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">:</span><span class="o">+</span><span class="p">)</span> <span class="o">/</span> <span class="no">FLOATS</span><span class="p">.</span><span class="nf">size</span>
<span class="s2">"Average is: </span><span class="si">#{</span><span class="n">avg</span><span class="si">}</span><span class="s2">"</span> <span class="c1"># =&gt; "Average is: 25.714285714285715</span>
<span class="s2">"Average is: </span><span class="si">#{</span><span class="n">avg</span><span class="p">.</span><span class="nf">round</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span> <span class="c1"># =&gt; "Average is: 25.7</span>
</code></pre>

<p>Normally, this is fine, but when working with some content, it may be nicer to use Ruby&rsquo;s String Format instead (especially if trying to format more complex numbers).</p>
<pre class="highlight ruby"><code><span class="s2">"Average is %.1f"</span> <span class="o">%</span> <span class="n">avg</span> <span class="c1"># =&gt; "Average is 25.7"</span>
</code></pre>

<p>We can also make printing hashes a little prettier as well.</p>
<pre class="highlight ruby"><code><span class="n">dog</span> <span class="o">=</span> <span class="p">{</span><span class="ss">name: </span><span class="s1">'poppy'</span><span class="p">,</span><span class="ss">breed: </span><span class="s1">'labrador'</span><span class="p">,</span><span class="ss">colour: </span><span class="s1">'black'</span><span class="p">}</span>

<span class="s2">"This is </span><span class="si">#{</span><span class="n">dog</span><span class="p">[</span><span class="ss">:name</span><span class="p">]</span><span class="si">}</span><span class="s2">, she is a </span><span class="si">#{</span><span class="n">dog</span><span class="p">[</span><span class="ss">:colour</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">dog</span><span class="p">[</span><span class="ss">:breed</span><span class="p">]</span><span class="si">}</span><span class="s2">."</span>
</code></pre>

<p>Becomes:</p>
<pre class="highlight ruby"><code><span class="s2">"This is %{name}, she is a %{colour} %{breed}."</span> <span class="o">%</span> <span class="p">[</span><span class="n">dog</span><span class="p">]</span>
</code></pre>

<p>Which, to me at least, reads a little nicer.</p>

<p><a href="http://apidock.com/ruby/Kernel/sprintf">Kernel::sprintf</a> has a more complete list of formatting strings.</p>
</div><div class="article__tags"><a href="/topics/ruby" class="article__tag">ruby</a></div></div><div class="article"><h2 class="article__title"><a href="/dynamic-classnames-in-slim/">Dynamic classnames in&nbsp;Slim</a></h2><div class="article__meta">Max Wheeler, 12 August 2015</div><div class="article__content" data-view-highlight=""><p>While glancing through one of Narinda’s pull-requests, I noticed she’d used a syntax for dynamic classnames in <a href="http://slim-lang.com/">Slim</a> that I had not seen before:</p>
<pre class="highlight slim"><code><span class="c">/ Aww yeah</span>
<span class="p">-</span> <span class="n">dynamic_classname</span> <span class="o">=</span> <span class="p">(</span><span class="n">truthy_test</span> <span class="p">?</span> <span class="s1">'foo'</span> <span class="p">:</span> <span class="s1">'bar'</span><span class="p">)</span>
<span class="nc">.static-class-name-one</span><span class="w"> </span><span class="na">class</span><span class="p">=</span><span class="err">[</span><span class="s">"static-class-name-two"</span>,<span class="w"> </span>dynamic_classname]
  <span class="p">'</span> Foo or bar?
</code></pre>

<p>Slim will magically convert concatenate the classnames based on the truthiness of the <code>truthy_test</code>. Much more flexible (and less stinky) than the string concatenation I would usually use:</p>
<pre class="highlight slim"><code><span class="c">/ Eww</span>
<span class="p">-</span> <span class="n">dynamic_classname</span> <span class="o">=</span> <span class="p">(</span><span class="n">truthy_test</span> <span class="p">?</span> <span class="s1">'foo'</span> <span class="p">:</span> <span class="s1">'bar'</span><span class="p">)</span>
<span class="nc">.static-class-name-one</span><span class="w"> </span><span class="na">class</span><span class="p">=</span><span class="s">"static-class-name-two #{dynamic_classname}"</span>
  <span class="p">'</span> Foo or bar?
</code></pre>
</div><div class="article__tags"><a href="/topics/slim" class="article__tag">slim</a><a href="/topics/ruby" class="article__tag">ruby</a></div></div><div class="pagination">Page 1 of 2<a href="/topics/ruby/page/2/" class="pagination__older">Older &rsaquo;</a></div></div><div class="footer">A knowledgebase of little learnings from the team at Icelab. <a href="https://github.com/icelab/til/">Source on GitHub</a>.</div><script>!function(t){function e(i){if(n[i])return n[i].exports;var o=n[i]={exports:{},id:i,loaded:!1};return t[i].call(o.exports,o,o.exports,e),o.loaded=!0,o.exports}var n={};return e.m=t,e.c=n,e.p="",e(0)}([function(t,e,n){t.exports=n(10)},,,,,,,function(t,e){!function(){function e(t,e){r?t.addEventListener("scroll",e,!1):t.attachEvent("scroll",e)}function n(t){document.body?t():r?document.addEventListener("DOMContentLoaded",t):document.attachEvent("onreadystatechange",function(){"interactive"!=document.readyState&&"complete"!=document.readyState||t()})}function i(t){this.a=document.createElement("div"),this.a.setAttribute("aria-hidden","true"),this.a.appendChild(document.createTextNode(t)),this.b=document.createElement("span"),this.c=document.createElement("span"),this.h=document.createElement("span"),this.f=document.createElement("span"),this.g=-1,this.b.style.cssText="max-width:none;display:inline-block;position:absolute;height:100%;width:100%;overflow:scroll;font-size:16px;",this.c.style.cssText="max-width:none;display:inline-block;position:absolute;height:100%;width:100%;overflow:scroll;font-size:16px;",this.f.style.cssText="max-width:none;display:inline-block;position:absolute;height:100%;width:100%;overflow:scroll;font-size:16px;",this.h.style.cssText="display:inline-block;width:200%;height:200%;font-size:16px;max-width:none;",this.b.appendChild(this.h),this.c.appendChild(this.f),this.a.appendChild(this.b),this.a.appendChild(this.c)}function o(t,e){t.a.style.cssText="max-width:none;min-width:20px;min-height:20px;display:inline-block;overflow:hidden;position:absolute;width:auto;margin:0;padding:0;top:-999px;left:-999px;white-space:nowrap;font:"+e+";"}function a(t){var e=t.a.offsetWidth,n=e+100;return t.f.style.width=n+"px",t.c.scrollLeft=n,t.b.scrollLeft=t.b.scrollWidth+100,t.g!==e?(t.g=e,!0):!1}function l(t,n){function i(){var t=o;a(t)&&null!==t.a.parentNode&&n(t.g)}var o=t;e(t.b,i),e(t.c,i),a(t)}function s(t,e){var n=e||{};this.family=t,this.style=n.style||"normal",this.weight=n.weight||"normal",this.stretch=n.stretch||"normal"}function c(){if(null===f){var t=document.createElement("div");try{t.style.font="condensed 100px sans-serif"}catch(e){}f=""!==t.style.font}return f}function d(t,e){return[t.style,t.weight,c()?t.stretch:"","100px",e].join(" ")}var r=!!document.addEventListener,h=null,f=null,m=!!window.FontFace;s.prototype.load=function(t,e){var a=this,s=t||"BESbswy",c=e||3e3,r=(new Date).getTime();return new Promise(function(t,e){if(m){var f=new Promise(function(t,e){function n(){(new Date).getTime()-r>=c?e():document.fonts.load(d(a,a.family),s).then(function(e){1<=e.length?t():setTimeout(n,25)},function(){e()})}n()}),u=new Promise(function(t,e){setTimeout(e,c)});Promise.race([u,f]).then(function(){t(a)},function(){e(a)})}else n(function(){function n(){var e;(e=-1!=w&&-1!=y||-1!=w&&-1!=v||-1!=y&&-1!=v)&&((e=w!=y&&w!=v&&y!=v)||(null===h&&(e=/AppleWebKit\/([0-9]+)(?:\.([0-9]+))/.exec(window.navigator.userAgent),h=!!e&&(536>parseInt(e[1],10)||536===parseInt(e[1],10)&&11>=parseInt(e[2],10))),e=h&&(w==g&&y==g&&v==g||w==x&&y==x&&v==x||w==b&&y==b&&v==b)),e=!e),e&&(null!==T.parentNode&&T.parentNode.removeChild(T),clearTimeout(E),t(a))}function f(){if((new Date).getTime()-r>=c)null!==T.parentNode&&T.parentNode.removeChild(T),e(a);else{var t=document.hidden;!0!==t&&void 0!==t||(w=m.a.offsetWidth,y=u.a.offsetWidth,v=p.a.offsetWidth,n()),E=setTimeout(f,50)}}var m=new i(s),u=new i(s),p=new i(s),w=-1,y=-1,v=-1,g=-1,x=-1,b=-1,T=document.createElement("div"),E=0;T.dir="ltr",o(m,d(a,"sans-serif")),o(u,d(a,"serif")),o(p,d(a,"monospace")),T.appendChild(m.a),T.appendChild(u.a),T.appendChild(p.a),document.body.appendChild(T),g=m.a.offsetWidth,x=u.a.offsetWidth,b=p.a.offsetWidth,f(),l(m,function(t){w=t,n()}),o(m,d(a,'"'+a.family+'",sans-serif')),l(u,function(t){y=t,n()}),o(u,d(a,'"'+a.family+'",serif')),l(p,function(t){v=t,n()}),o(p,d(a,'"'+a.family+'",monospace'))})})},window.FontFaceObserver=s,window.FontFaceObserver.prototype.check=window.FontFaceObserver.prototype.load=s.prototype.load,"undefined"!=typeof t&&(t.exports=window.FontFaceObserver)}()},,function(t,e,n){function i(t){var e=window.localStorage.getItem("fontsLoaded");if(!e){var n=[];t.forEach(function(t){var e=new window.FontFaceObserver(t.family,{weight:t.weight,style:t.style});n.push(e.check())}),Promise.all(n).then(function(){window.document.documentElement.className+=" fonts-loaded",window.localStorage.setItem("fontsLoaded",!0)})}}n(7);var o=[{family:"National",style:"normal",weight:"normal"},{family:"National",style:"italic",weight:"normal"},{family:"National",style:"italic",weight:"bold"},{family:"National",style:"italic",weight:"bold"},{family:"TiemposText",style:"normal",weight:"normal"},{family:"TiemposText",style:"italic",weight:"normal"},{family:"TiemposText",style:"italic",weight:"bold"},{family:"TiemposText",style:"italic",weight:"bold"},{family:"Inconsolata",style:"normal",weight:"400"},{family:"Inconsolata",style:"italic",weight:"400"}];i(o)},function(t,e,n){n.p="/assets/",n(9)}]);</script></body></html>