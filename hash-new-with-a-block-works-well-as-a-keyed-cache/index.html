<!DOCTYPE html><html lang="en-au"><head><meta charset="utf-8" /><meta content="width=device-width, initial-scale=1.0" name="viewport" /><meta content="Today Icelab Learned" property="og:site_name" /><meta content="http://til.icelab.com.au/hash-new-with-a-block-works-well-as-a-keyed-cache/" property="og:url" /><meta content="article" property="og:type" /><meta content="Hash.new with a block works well as a keyed cache" property="og:title" /><meta content="We&rsquo;re all familiar with the @foo ||= expensive_computation technique to memoize (i.e. cache) the output of slow computations or to avoid unnecessary object creation.

If you want to do the same but with results that will vary by a single parameter, you can use Ruby&rsquo;s hash with its block-based initializer to handle the caching for you:
def my_cache
  @my_cache ||= Hash.new do |hash, key..." property="og:description" /><meta name="twitter:label1" value="Tagged with" /><meta name="twitter:data1" value="ruby" /><meta name="twitter:label2" value="Author" /><meta name="twitter:data2" value="Tim Riley" /><script>!function(o){function t(n){if(e[n])return e[n].exports;var r=e[n]={exports:{},id:n,loaded:!1};return o[n].call(r.exports,r,r.exports,t),r.loaded=!0,r.exports}var e={};return t.m=o,t.c=e,t.p="",t(0)}({0:function(o,t,e){o.exports=e(12)},11:function(o,t){window.localStorage.getItem("fontsLoaded")&&(window.document.documentElement.className+=" fonts-loaded")},12:function(o,t,e){e.p="/assets/",e(11)}});</script><link href="https://til.icelab.com.au/assets/public/favicon-fe80d575.png" rel="shortcut icon" /><link href="https://til.icelab.com.au/assets/public-8b27d484.css" rel="stylesheet" type="text/css" /><link href="https://fonts.googleapis.com/css?family=Inconsolata:400,700:latin" rel="stylesheet" type="text/css" /><script async="" src="https://til.icelab.com.au/assets/public-49d86d77.js"></script><title>Today Icelab Learned about 'Hash.new with a block works well as a keyed cache'</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', "UA-2193586-3", 'auto');
ga('send', 'pageview');</script><link href="/feed.xml" rel="alternate" title="Today Icelab Learned" type="application/atom+xml" /></head><body><aside class="sidebar" id="sidebar"><button class="close-sidebar" data-view-toggle-sidebar="">Hide topics &rsaquo; </button><div class="sidebar-topic"><a href="/topics/accessibility">accessibility</a><span class="topic-count"> (<i>2</i>)</span></div><div class="sidebar-topic"><a href="/topics/analytics">analytics</a><span class="topic-count"> (<i>1</i>)</span></div><div class="sidebar-topic"><a href="/topics/aws">aws</a><span class="topic-count"> (<i>3</i>)</span></div><div class="sidebar-topic"><a href="/topics/css">css</a><span class="topic-count"> (<i>3</i>)</span></div><div class="sidebar-topic"><a href="/topics/debugging">debugging</a><span class="topic-count"> (<i>1</i>)</span></div><div class="sidebar-topic"><a href="/topics/git">git</a><span class="topic-count"> (<i>3</i>)</span></div><div class="sidebar-topic"><a href="/topics/heroku">heroku</a><span class="topic-count"> (<i>1</i>)</span></div><div class="sidebar-topic"><a href="/topics/html">html</a><span class="topic-count"> (<i>1</i>)</span></div><div class="sidebar-topic"><a href="/topics/javascript">javascript</a><span class="topic-count"> (<i>4</i>)</span></div><div class="sidebar-topic"><a href="/topics/nginx">nginx</a><span class="topic-count"> (<i>1</i>)</span></div><div class="sidebar-topic"><a href="/topics/ops">ops</a><span class="topic-count"> (<i>2</i>)</span></div><div class="sidebar-topic"><a href="/topics/performance">performance</a><span class="topic-count"> (<i>1</i>)</span></div><div class="sidebar-topic"><a href="/topics/postgres">postgres</a><span class="topic-count"> (<i>1</i>)</span></div><div class="sidebar-topic"><a href="/topics/processing">processing</a><span class="topic-count"> (<i>1</i>)</span></div><div class="sidebar-topic"><a href="/topics/rails">rails</a><span class="topic-count"> (<i>4</i>)</span></div><div class="sidebar-topic"><a href="/topics/rake">rake</a><span class="topic-count"> (<i>1</i>)</span></div><div class="sidebar-topic"><a href="/topics/react">react</a><span class="topic-count"> (<i>2</i>)</span></div><div class="sidebar-topic"><a href="/topics/regex">regex</a><span class="topic-count"> (<i>1</i>)</span></div><div class="sidebar-topic"><a href="/topics/ruby">ruby</a><span class="topic-count"> (<i>13</i>)</span></div><div class="sidebar-topic"><a href="/topics/seo">seo</a><span class="topic-count"> (<i>1</i>)</span></div><div class="sidebar-topic"><a href="/topics/slim">slim</a><span class="topic-count"> (<i>1</i>)</span></div><div class="sidebar-topic"><a href="/topics/social">social</a><span class="topic-count"> (<i>2</i>)</span></div><div class="sidebar-topic"><a href="/topics/testing">testing</a><span class="topic-count"> (<i>1</i>)</span></div></aside><div class="header"><a class="header__logo" href="http://www.icelab.com.au"></a><a href="/" class="header__til-text">Today Icelab Learned</a><button class="header__view-topics open-sidebar" data-view-toggle-sidebar="">&lsaquo; <span>View</span> topics </button></div><div class="container"><div class="article"><h2 class="article__title">Hash.new with a block works well as a keyed&nbsp;cache</h2><div class="article__meta">Tim Riley, 23 May 2016</div><div class="article__content" data-view-highlight=""><p>We&rsquo;re all familiar with the <code>@foo ||= expensive_computation</code> technique to memoize (i.e. cache) the output of slow computations or to avoid unnecessary object creation.</p>

<p>If you want to do the same but with results that will vary by a single parameter, you can use Ruby&rsquo;s hash with its <a href="http://ruby-doc.org/core-2.3.1/Hash.html#method-c-new">block-based initializer</a> to handle the caching for you:</p>
<pre class="highlight ruby"><code><span class="k">def</span> <span class="nf">my_cache</span>
  <span class="vi">@my_cache</span> <span class="o">||=</span> <span class="no">Hash</span><span class="p">.</span><span class="nf">new</span> <span class="k">do</span> <span class="o">|</span><span class="nb">hash</span><span class="p">,</span> <span class="n">key</span><span class="o">|</span>
    <span class="nb">hash</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">some_slow_computation</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># Computed once</span>
<span class="n">my_cache</span><span class="p">[</span><span class="ss">:foo</span><span class="p">]</span>

<span class="c1"># Then cached</span>
<span class="n">my_cache</span><span class="p">[</span><span class="ss">:foo</span><span class="p">]</span>
</code></pre>

<p>You can see this work in practice <a href="https://github.com/dry-rb/dry-component/blob/0bebc656b625a18c25e3c8d9c4b71946fecac5e1/lib/dry/component/injector.rb#L56-L60">inside dry-component&rsquo;s Injector</a>, where it caches objects to allow arbitrarily long chaining of injector strategies without creating duplicate injector objects.</p>
</div><div class="article__tags"><a href="/topics/ruby" class="article__tag">ruby</a></div></div></div><div class="footer">A knowledgebase of little learnings from the team at Icelab. <a href="https://github.com/icelab/til/">Source on GitHub</a>.</div><script>!function(t){function e(i){if(n[i])return n[i].exports;var o=n[i]={exports:{},id:i,loaded:!1};return t[i].call(o.exports,o,o.exports,e),o.loaded=!0,o.exports}var n={};return e.m=t,e.c=n,e.p="",e(0)}([function(t,e,n){t.exports=n(10)},,,,,,,function(t,e){!function(){function e(t,e){r?t.addEventListener("scroll",e,!1):t.attachEvent("scroll",e)}function n(t){document.body?t():r?document.addEventListener("DOMContentLoaded",t):document.attachEvent("onreadystatechange",function(){"interactive"!=document.readyState&&"complete"!=document.readyState||t()})}function i(t){this.a=document.createElement("div"),this.a.setAttribute("aria-hidden","true"),this.a.appendChild(document.createTextNode(t)),this.b=document.createElement("span"),this.c=document.createElement("span"),this.h=document.createElement("span"),this.f=document.createElement("span"),this.g=-1,this.b.style.cssText="max-width:none;display:inline-block;position:absolute;height:100%;width:100%;overflow:scroll;font-size:16px;",this.c.style.cssText="max-width:none;display:inline-block;position:absolute;height:100%;width:100%;overflow:scroll;font-size:16px;",this.f.style.cssText="max-width:none;display:inline-block;position:absolute;height:100%;width:100%;overflow:scroll;font-size:16px;",this.h.style.cssText="display:inline-block;width:200%;height:200%;font-size:16px;max-width:none;",this.b.appendChild(this.h),this.c.appendChild(this.f),this.a.appendChild(this.b),this.a.appendChild(this.c)}function o(t,e){t.a.style.cssText="max-width:none;min-width:20px;min-height:20px;display:inline-block;overflow:hidden;position:absolute;width:auto;margin:0;padding:0;top:-999px;left:-999px;white-space:nowrap;font:"+e+";"}function a(t){var e=t.a.offsetWidth,n=e+100;return t.f.style.width=n+"px",t.c.scrollLeft=n,t.b.scrollLeft=t.b.scrollWidth+100,t.g!==e?(t.g=e,!0):!1}function l(t,n){function i(){var t=o;a(t)&&null!==t.a.parentNode&&n(t.g)}var o=t;e(t.b,i),e(t.c,i),a(t)}function s(t,e){var n=e||{};this.family=t,this.style=n.style||"normal",this.weight=n.weight||"normal",this.stretch=n.stretch||"normal"}function c(){if(null===f){var t=document.createElement("div");try{t.style.font="condensed 100px sans-serif"}catch(e){}f=""!==t.style.font}return f}function d(t,e){return[t.style,t.weight,c()?t.stretch:"","100px",e].join(" ")}var r=!!document.addEventListener,h=null,f=null,m=!!window.FontFace;s.prototype.load=function(t,e){var a=this,s=t||"BESbswy",c=e||3e3,r=(new Date).getTime();return new Promise(function(t,e){if(m){var f=new Promise(function(t,e){function n(){(new Date).getTime()-r>=c?e():document.fonts.load(d(a,a.family),s).then(function(e){1<=e.length?t():setTimeout(n,25)},function(){e()})}n()}),u=new Promise(function(t,e){setTimeout(e,c)});Promise.race([u,f]).then(function(){t(a)},function(){e(a)})}else n(function(){function n(){var e;(e=-1!=w&&-1!=y||-1!=w&&-1!=v||-1!=y&&-1!=v)&&((e=w!=y&&w!=v&&y!=v)||(null===h&&(e=/AppleWebKit\/([0-9]+)(?:\.([0-9]+))/.exec(window.navigator.userAgent),h=!!e&&(536>parseInt(e[1],10)||536===parseInt(e[1],10)&&11>=parseInt(e[2],10))),e=h&&(w==g&&y==g&&v==g||w==x&&y==x&&v==x||w==b&&y==b&&v==b)),e=!e),e&&(null!==T.parentNode&&T.parentNode.removeChild(T),clearTimeout(E),t(a))}function f(){if((new Date).getTime()-r>=c)null!==T.parentNode&&T.parentNode.removeChild(T),e(a);else{var t=document.hidden;!0!==t&&void 0!==t||(w=m.a.offsetWidth,y=u.a.offsetWidth,v=p.a.offsetWidth,n()),E=setTimeout(f,50)}}var m=new i(s),u=new i(s),p=new i(s),w=-1,y=-1,v=-1,g=-1,x=-1,b=-1,T=document.createElement("div"),E=0;T.dir="ltr",o(m,d(a,"sans-serif")),o(u,d(a,"serif")),o(p,d(a,"monospace")),T.appendChild(m.a),T.appendChild(u.a),T.appendChild(p.a),document.body.appendChild(T),g=m.a.offsetWidth,x=u.a.offsetWidth,b=p.a.offsetWidth,f(),l(m,function(t){w=t,n()}),o(m,d(a,'"'+a.family+'",sans-serif')),l(u,function(t){y=t,n()}),o(u,d(a,'"'+a.family+'",serif')),l(p,function(t){v=t,n()}),o(p,d(a,'"'+a.family+'",monospace'))})})},window.FontFaceObserver=s,window.FontFaceObserver.prototype.check=window.FontFaceObserver.prototype.load=s.prototype.load,"undefined"!=typeof t&&(t.exports=window.FontFaceObserver)}()},,function(t,e,n){function i(t){var e=window.localStorage.getItem("fontsLoaded");if(!e){var n=[];t.forEach(function(t){var e=new window.FontFaceObserver(t.family,{weight:t.weight,style:t.style});n.push(e.check())}),Promise.all(n).then(function(){window.document.documentElement.className+=" fonts-loaded",window.localStorage.setItem("fontsLoaded",!0)})}}n(7);var o=[{family:"National",style:"normal",weight:"normal"},{family:"National",style:"italic",weight:"normal"},{family:"National",style:"italic",weight:"bold"},{family:"National",style:"italic",weight:"bold"},{family:"TiemposText",style:"normal",weight:"normal"},{family:"TiemposText",style:"italic",weight:"normal"},{family:"TiemposText",style:"italic",weight:"bold"},{family:"TiemposText",style:"italic",weight:"bold"},{family:"Inconsolata",style:"normal",weight:"400"},{family:"Inconsolata",style:"italic",weight:"400"}];i(o)},function(t,e,n){n.p="/assets/",n(9)}]);</script></body></html>