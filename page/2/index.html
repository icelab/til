<!DOCTYPE html><html lang="en-au"><head><meta charset="utf-8" /><meta content="width=device-width, initial-scale=1.0" name="viewport" /><meta content="Today Icelab Learned" property="og:site_name" /><meta content="http://til.icelab.com.au/page/2/" property="og:url" /><meta content="article" property="og:type" /><meta content="A knowledgebase of little learnings from the team at Icelab." property="og:description" /><script>!function(o){function t(n){if(e[n])return e[n].exports;var r=e[n]={exports:{},id:n,loaded:!1};return o[n].call(r.exports,r,r.exports,t),r.loaded=!0,r.exports}var e={};return t.m=o,t.c=e,t.p="",t(0)}({0:function(o,t,e){o.exports=e(12)},11:function(o,t){window.localStorage.getItem("fontsLoaded")&&(window.document.documentElement.className+=" fonts-loaded")},12:function(o,t,e){e.p="/assets/",e(11)}});</script><link href="http://til.icelab.com.au/assets/public/favicon-fe80d575.png" rel="shortcut icon" /><link href="http://til.icelab.com.au/assets/public-8b27d484.css" rel="stylesheet" type="text/css" /><link href="https://fonts.googleapis.com/css?family=Inconsolata:400,700:latin" rel="stylesheet" type="text/css" /><script async="" src="http://til.icelab.com.au/assets/public-49d86d77.js"></script><title>Today Icelab Learned</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', "UA-2193586-3", 'auto');
ga('send', 'pageview');</script><link href="/feed.xml" rel="alternate" title="Today Icelab Learned" type="application/atom+xml" /></head><body><aside class="sidebar" id="sidebar"><button class="close-sidebar" data-view-toggle-sidebar="">Hide topics &rsaquo; </button><div class="sidebar-topic"><a href="/topics/accessibility">accessibility</a><span class="topic-count"> (<i>2</i>)</span></div><div class="sidebar-topic"><a href="/topics/analytics">analytics</a><span class="topic-count"> (<i>1</i>)</span></div><div class="sidebar-topic"><a href="/topics/aws">aws</a><span class="topic-count"> (<i>3</i>)</span></div><div class="sidebar-topic"><a href="/topics/css">css</a><span class="topic-count"> (<i>1</i>)</span></div><div class="sidebar-topic"><a href="/topics/debugging">debugging</a><span class="topic-count"> (<i>1</i>)</span></div><div class="sidebar-topic"><a href="/topics/git">git</a><span class="topic-count"> (<i>2</i>)</span></div><div class="sidebar-topic"><a href="/topics/html">html</a><span class="topic-count"> (<i>1</i>)</span></div><div class="sidebar-topic"><a href="/topics/javascript">javascript</a><span class="topic-count"> (<i>4</i>)</span></div><div class="sidebar-topic"><a href="/topics/ops">ops</a><span class="topic-count"> (<i>1</i>)</span></div><div class="sidebar-topic"><a href="/topics/performance">performance</a><span class="topic-count"> (<i>1</i>)</span></div><div class="sidebar-topic"><a href="/topics/postgres">postgres</a><span class="topic-count"> (<i>1</i>)</span></div><div class="sidebar-topic"><a href="/topics/processing">processing</a><span class="topic-count"> (<i>1</i>)</span></div><div class="sidebar-topic"><a href="/topics/rails">rails</a><span class="topic-count"> (<i>4</i>)</span></div><div class="sidebar-topic"><a href="/topics/react">react</a><span class="topic-count"> (<i>2</i>)</span></div><div class="sidebar-topic"><a href="/topics/regex">regex</a><span class="topic-count"> (<i>1</i>)</span></div><div class="sidebar-topic"><a href="/topics/ruby">ruby</a><span class="topic-count"> (<i>10</i>)</span></div><div class="sidebar-topic"><a href="/topics/seo">seo</a><span class="topic-count"> (<i>1</i>)</span></div><div class="sidebar-topic"><a href="/topics/slim">slim</a><span class="topic-count"> (<i>1</i>)</span></div><div class="sidebar-topic"><a href="/topics/social">social</a><span class="topic-count"> (<i>2</i>)</span></div><div class="sidebar-topic"><a href="/topics/testing">testing</a><span class="topic-count"> (<i>1</i>)</span></div></aside><div class="header"><a class="header__logo" href="http://www.icelab.com.au"></a><a href="/" class="header__til-text">Today Icelab Learned</a><button class="header__view-topics open-sidebar" data-view-toggle-sidebar="">&lsaquo; <span>View</span> topics </button></div><div class="container"><div class="article"><h2 class="article__title"><a href="/async-set-state/">In React setState is not &quot;guaranteed&quot; to be&nbsp;synchronous.</a></h2><div class="article__meta">Narinda Reeders, 19 November 2015</div><div class="article__content" data-view-highlight=""><p>I discovered recently that if you do something link this in react:</p>
<pre class="highlight javascript"><code><span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span><span class="na">reallyUseful</span><span class="p">:</span> <span class="kc">true</span><span class="p">})</span>

<span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">reallyUseful</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">doSomethingAmazing</span><span class="p">()</span>
<span class="p">}</span>
</code></pre>

<p>&hellip; it&rsquo;s not very useful and more often than not nothing amazing happens, just confusion and sadness.</p>

<p>This is because <code>setState</code> it turns out, is asynchronous. Of course most of the time you are doing your amazing things in your render function so everything is sweet but on the odd occasion that you need to pass that value elsewhere, eg: publishing an event, beware!</p>

<p>From the docs:</p>

<blockquote>
<p>setState() does not immediately mutate this.state but creates a pending state transition. Accessing this.state after calling this method can potentially return the existing value.</p>

<p>There is no guarantee of synchronous operation of calls to setState and calls may be batched for performance gains.</p>
</blockquote>

<p>Read about <code>setState</code> <a href="https://facebook.github.io/react/docs/component-api.html">here</a>.</p>

<p><em>Editor’s note — <code>setState</code> will also take a callback as its second argument that’ll be executed after <code>this.state</code> has been updated:</em></p>
<pre class="highlight javascript"><code><span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">(</span>
  <span class="p">{</span> <span class="na">reallyUseful</span><span class="p">:</span> <span class="kc">true</span> <span class="p">},</span>
  <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">reallyUseful</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">doSomethingAmazing</span><span class="p">()</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">)</span>
</code></pre>
</div><div class="article__tags"><a href="/topics/react" class="article__tag">react</a><a href="/topics/javascript" class="article__tag">javascript</a></div></div><div class="article"><h2 class="article__title"><a href="/pry-is-amazing/">Pry is&nbsp;amazing</a></h2><div class="article__meta">Tim Riley, 11 November 2015</div><div class="article__content" data-view-highlight=""><p><a href="https://github.com/pry/pry">Pry</a> is amazing! It has a whole bunch of helpful shortcuts you can use while working in a session.</p>

<p>I found the <a href="https://github.com/pry/pry/wiki/Exceptions">exception handling shortcuts</a> particularly helpful. <code>_ex_</code> will give you the last raised exception, and <code>wtf?</code> will show you a stacktrace from that exception (which is helpful, since stacktraces aren&rsquo;t normally shown in interactive terminal sessions like this). Hilariously, you can add more question marks or exclamation marks on the end to see more detail.</p>

<p>If you work with Ruby app consoles regularly, you&rsquo;d do yourself a favour to give the <a href="https://github.com/pry/pry/wiki">Pry Wiki</a> a good read!</p>
</div><div class="article__tags"><a href="/topics/ruby" class="article__tag">ruby</a><a href="/topics/debugging" class="article__tag">debugging</a></div></div><div class="article"><h2 class="article__title"><a href="/aws-elasticsearch-authentication/">Authenticating with AWS&nbsp;Elasticsearch</a></h2><div class="article__meta">Andrew Croome, 21 October 2015</div><div class="article__content" data-view-highlight=""><p>The AWS Elasticseach service offers authentication via an IAM user, or by whitelisting IPs.</p>

<p>Here&rsquo;s how to use IAM credentials to sign requests to the service when using Faraday and how to hook that into the Ruby elasticsearch gem.</p>

<p>To sign requests using Faraday, you can use a gem called <a href="https://github.com/winebarrel/faraday_middleware-aws-signers-v4">faraday_middleware-aws-signers-v4</a>, which provides a middleware that will sign your requests.</p>
<pre class="highlight ruby"><code><span class="nb">require</span> <span class="s1">'faraday_middleware'</span>
<span class="nb">require</span> <span class="s1">'faraday_middleware/aws_signers_v4'</span>

<span class="n">conn</span> <span class="o">=</span> <span class="no">Faraday</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">url: </span><span class="s1">'address-of-your-AWS-es-service'</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">faraday</span><span class="o">|</span>
  <span class="n">faraday</span><span class="p">.</span><span class="nf">request</span> <span class="ss">:aws_signers_v4</span><span class="p">,</span> <span class="p">{</span>
    <span class="ss">credentials: </span><span class="no">Aws</span><span class="o">::</span><span class="no">Credentials</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="no">ENV</span><span class="p">[</span><span class="s1">'AWS_ACCESS_KEY_ID'</span><span class="p">],</span> <span class="no">ENV</span><span class="p">[</span><span class="s1">'AWS_SECRET_ACCESS_KEY'</span><span class="p">]),</span>
    <span class="ss">service_name: </span><span class="s1">'es'</span><span class="p">,</span>
    <span class="ss">region: </span><span class="s1">'ap-southeast-2'</span>
  <span class="p">}</span>

  <span class="n">faraday</span><span class="p">.</span><span class="nf">adapter</span> <span class="ss">:typhoeus</span>
<span class="k">end</span>
</code></pre>

<p>To get the client provided by the elasticsearch gem to use your Faraday configuation, you can pass that configuration to it like so:</p>
<pre class="highlight ruby"><code><span class="n">faraday_config</span> <span class="o">=</span> <span class="nb">lambda</span> <span class="k">do</span> <span class="o">|</span><span class="n">faraday</span><span class="o">|</span>
  <span class="n">faraday</span><span class="p">.</span><span class="nf">request</span> <span class="ss">:aws_signers_v4</span><span class="p">,</span> <span class="p">{</span>
    <span class="ss">credentials: </span><span class="no">Aws</span><span class="o">::</span><span class="no">Credentials</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span>
      <span class="no">ENV</span><span class="p">[</span><span class="s2">"ELASTICSEARCH_AWS_ACCESS_KEY_ID"</span><span class="p">],</span>
      <span class="no">ENV</span><span class="p">[</span><span class="s2">"ELASTICSEARCH_AWS_SECRET_ACCESS_KEY"</span><span class="p">]</span>
      <span class="p">),</span>
      <span class="ss">service_name: </span><span class="s2">"es"</span><span class="p">,</span>
      <span class="ss">region: </span><span class="no">ENV</span><span class="p">[</span><span class="s2">"ELASTICSEARCH_AWS_REGION"</span><span class="p">]</span>
    <span class="p">}</span>
    <span class="n">faraday</span><span class="p">.</span><span class="nf">adapter</span> <span class="ss">:typhoeus</span>
  <span class="k">end</span>

<span class="n">elasticsearch_host_config</span> <span class="o">=</span> <span class="p">{</span>
  <span class="ss">host:   </span><span class="no">ENV</span><span class="p">[</span><span class="s2">"ELASTICSEARCH_HOST"</span><span class="p">],</span>
  <span class="ss">port:   </span><span class="no">ENV</span><span class="p">[</span><span class="s2">"ELASTICSEARCH_PORT"</span><span class="p">],</span>
  <span class="ss">scheme: </span><span class="no">ENV</span><span class="p">[</span><span class="s2">"ELASTICSEARCH_SCHEME"</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">transport</span> <span class="o">=</span> <span class="no">Elasticsearch</span><span class="o">::</span><span class="no">Transport</span><span class="o">::</span><span class="no">Transport</span><span class="o">::</span><span class="no">HTTP</span><span class="o">::</span><span class="no">Faraday</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">hosts: </span><span class="p">[</span><span class="n">elasticsearch_host_config</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">faraday_config</span><span class="p">)</span>

<span class="n">client</span> <span class="o">=</span> <span class="no">Elasticsearch</span><span class="o">::</span><span class="no">Client</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">transport: </span><span class="n">transport</span><span class="p">)</span>
</code></pre>

<p>You can then use the client object as usual, and you&rsquo;ll get automatically signed requests.</p>
</div><div class="article__tags"><a href="/topics/ruby" class="article__tag">ruby</a><a href="/topics/aws" class="article__tag">aws</a></div></div><div class="article"><h2 class="article__title"><a href="/using-arel-to-compare-attributes-of-a-record/">Using Arel to compare attributes of a&nbsp;record</a></h2><div class="article__meta">Daniel Nitsikopoulos, 24 September 2015</div><div class="article__content" data-view-highlight=""><p>I was just trying to find a way to run a query and compare the <code>updated_at</code> and <code>created_at</code> attributes of a record and came across this technique:</p>
<pre class="highlight ruby"><code><span class="n">users</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">arel_table</span>
<span class="no">User</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="n">users</span><span class="p">[</span><span class="ss">:created_at</span><span class="p">].</span><span class="nf">eq</span><span class="p">(</span><span class="n">users</span><span class="p">[</span><span class="ss">:updated_at</span><span class="p">]))</span>
</code></pre>

<p>It seems like <code>.gt</code> and <code>.lt</code> also work. While <code>User.where(&quot;created_at = updated_at&quot;)</code> would also work in SQL, we can use Arel to be database agnostic.</p>

<p><em><a href="https://github.com/rails/arel">Arel docs</a></em></p>
</div><div class="article__tags"><a href="/topics/rails" class="article__tag">rails</a></div></div><div class="article"><h2 class="article__title"><a href="/manually-incrementing-count-columns/">Manually incrementing count columns in&nbsp;rails</a></h2><div class="article__meta">Daniel Nitsikopoulos, 18 September 2015</div><div class="article__content" data-view-highlight=""><p>Adding a counter cache column to a model is a common optimisation we make in order to avoid unnecessary queries when trying to aggregate data associated with that particular model. Rails provides us with a number of ways to maintain the counter cache column&rsquo;s value. The first is to follow the rails convention and add <code>counter_cache: true</code> to a <code>belongs_to</code> association and ensure we have a correctly named <code>*_count</code> column.</p>

<p>The other way to do it, is manually. In this case rails provides us with a few convenience methods to increment a given column.</p>

<p>The first is <code>ActiveRecord::Base#increment!(attribute, by)</code>.</p>

<p><code>increment!</code> is defined as:</p>
<pre class="highlight ruby"><code><span class="k">def</span> <span class="nf">increment!</span><span class="p">(</span><span class="n">attribute</span><span class="p">,</span> <span class="n">by</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
  <span class="n">increment</span><span class="p">(</span><span class="n">attribute</span><span class="p">,</span> <span class="n">by</span><span class="p">).</span><span class="nf">update_attribute</span><span class="p">(</span><span class="n">attribute</span><span class="p">,</span> <span class="nb">self</span><span class="p">[</span><span class="n">attribute</span><span class="p">])</span>
<span class="k">end</span>
</code></pre>

<p>and <code>increment</code> is defined as:</p>
<pre class="highlight ruby"><code><span class="k">def</span> <span class="nf">increment</span><span class="p">(</span><span class="n">attribute</span><span class="p">,</span> <span class="n">by</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
  <span class="nb">self</span><span class="p">[</span><span class="n">attribute</span><span class="p">]</span> <span class="o">||=</span> <span class="mi">0</span>
  <span class="nb">self</span><span class="p">[</span><span class="n">attribute</span><span class="p">]</span> <span class="o">+=</span> <span class="n">by</span>
  <span class="nb">self</span>
<span class="k">end</span>
</code></pre>

<p>Which means that we&rsquo;re first fetching the current attribute&rsquo;s value, incrementing it then passing it on to <code>update_attribute</code> before it can be saved. This method leads to a non-atomic database operation, that is to say that at one point, the count is different in memory than it is in the database (which can lead to race conditions).</p>

<p>The second is <code>ActiveRecord::Base#increment_counter(column_name, record_id)</code></p>

<p><code>increment_counter</code> is defined as:</p>
<pre class="highlight ruby"><code><span class="k">def</span> <span class="nf">increment_counter</span><span class="p">(</span><span class="n">counter_name</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
  <span class="n">update_counters</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">counter_name</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">)</span>
<span class="k">end</span>
</code></pre>

<p>which executes SQL like:</p>
<pre class="highlight sql"><code><span class="k">UPDATE</span> <span class="nv">"table_name"</span>
  <span class="k">SET</span> <span class="nv">"counter_name"</span> <span class="o">=</span> <span class="nv">"counter_name"</span> <span class="o">+</span> <span class="mi">1</span>
  <span class="k">WHERE</span> <span class="n">id</span> <span class="o">=</span> <span class="mi">1</span>
</code></pre>

<p>This means that we now have an atomic operation and the counter cache value is the same across the system.</p>

<p>Docs:</p>

<ul>
<li><a href="http://apidock.com/rails/ActiveRecord/Base/increment!">increment!</a></li>
<li><a href="http://apidock.com/rails/ActiveRecord/Base/increment_counter/class">increment_counter</a></li>
</ul>
</div><div class="article__tags"><a href="/topics/rails" class="article__tag">rails</a><a href="/topics/ruby" class="article__tag">ruby</a></div></div><div class="article"><h2 class="article__title"><a href="/setting-cookies-in-request-specs/">Setting cookies in request&nbsp;specs</a></h2><div class="article__meta">Narinda Reeders, 17 September 2015</div><div class="article__content" data-view-highlight=""><p>When writing request specs and you want to set a cookie, setting it with Capybara doesn’t seem to work, best to set it in the request headers.</p>

<p>Sad panda:</p>
<pre class="highlight ruby"><code><span class="no">Capybara</span><span class="p">.</span><span class="nf">current_session</span><span class="p">.</span><span class="nf">driver</span><span class="p">.</span><span class="nf">browser</span><span class="p">.</span><span class="nf">set_cookie</span><span class="p">(</span><span class="s2">"really_useful_cookie=</span><span class="si">#{</span><span class="n">cookie_monster</span><span class="p">.</span><span class="nf">id</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</code></pre>

<p>Happy panda:</p>
<pre class="highlight ruby"><code><span class="n">get</span> <span class="n">some_path</span><span class="p">,</span> <span class="p">{},</span> <span class="p">{</span><span class="s2">"HTTP_COOKIE"</span> <span class="o">=&gt;</span> <span class="s2">"really_useful_cookie=</span><span class="si">#{</span><span class="n">cookie_monster</span><span class="p">.</span><span class="nf">id</span><span class="si">}</span><span class="s2">”}
</span></code></pre>
</div><div class="article__tags"><a href="/topics/testing" class="article__tag">testing</a></div></div><div class="article"><h2 class="article__title"><a href="/using-viewloader-with-turbolinks/">Using viewloader with&nbsp;turbolinks</a></h2><div class="article__meta">Andrew Croome, 17 September 2015</div><div class="article__content" data-view-highlight=""><p>When using viewloader with turbolinks, you want to make sure that viewloader executes once on the initial page load, once when the visitor reaches another page, and once when the visitor goes back in their browser (or forward for that matter).</p>

<p>To achieve this, get viewloader to execute on the <code>ready</code>, <code>page:load</code> and <code>page:restore</code> events:</p>
<pre class="highlight javascript"><code><span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s2">"ready page:load page:restore"</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">viewloader</span><span class="p">.</span><span class="nx">execute</span><span class="p">(</span><span class="nx">views</span><span class="p">);</span>
<span class="p">});</span>
</code></pre>

<p><code>page:restore</code> is fired by <a href="https://github.com/rails/turbolinks">turbolinks</a> whenever &ldquo;A cached body element has been loaded into the DOM&rdquo;.</p>
</div><div class="article__tags"><a href="/topics/javascript" class="article__tag">javascript</a></div></div><div class="article"><h2 class="article__title"><a href="/manually-add-sitemaps-to-googles-webmaster-tools/">Manually add sitemaps to Google’s Webmaster&nbsp;Tools</a></h2><div class="article__meta">Max Wheeler, 15 September 2015</div><div class="article__content" data-view-highlight=""><p>It’s good practice to add sitemaps to <a href="https://www.google.com/webmasters/tools/">Google’s Webmaster Tools</a> so you can check their health and get notifications about sitemap issues. We often host sitemaps on S3 because they could be large static files that we don’t want running through our Rails stack.</p>

<p>This leads us to the problem: If you have a sitemap that’s hosted externally to your website, you can’t add them through the Google’s Webmaster Tools interface. For some reason Google limits these to paths underneath the official domain attached to an account. There is a solution though — you can sneak them in using their notification URL. All you need to do is:</p>
<pre class="highlight plaintext"><code>curl www.google.com/webmasters/tools/ping?sitemap=https%3A%2F%2Fwheeler-centre-heracles.s3.amazonaws.com%2Fsitemaps%2Fsitemap.xml.gz
</code></pre>

<p>And ta da, it’ll show up in the Webmaster Tools admin interface.</p>
</div><div class="article__tags"><a href="/topics/seo" class="article__tag">seo</a></div></div><div class="article"><h2 class="article__title"><a href="/postgres-listen-notify/">PostgreSQL as a message&nbsp;bus</a></h2><div class="article__meta">Alex Timofeev, 15 September 2015</div><div class="article__content" data-view-highlight=""><p>PostgreSQL has its own listen/notify mechanism. It might be useful for cases when we have to manage messaging between different application processes, but would prefer to not use extra dependencies such as Redis.</p>

<p><em>process.rb</em></p>
<pre class="highlight ruby"><code><span class="no">CHANNEL</span>       <span class="o">=</span> <span class="s2">"slack_bot"</span>
<span class="no">RESET_CHANNEL</span> <span class="o">=</span> <span class="s2">"pg_restart"</span>

<span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="p">.</span><span class="nf">connection_pool</span><span class="p">.</span><span class="nf">with_connection</span> <span class="k">do</span> <span class="o">|</span><span class="n">connection</span><span class="o">|</span>
  <span class="n">conn</span> <span class="o">=</span> <span class="n">connection</span><span class="p">.</span><span class="nf">instance_variable_get</span><span class="p">(</span><span class="ss">:@connection</span><span class="p">)</span>
  <span class="k">begin</span>
    <span class="n">conn</span><span class="p">.</span><span class="nf">async_exec</span> <span class="s2">"LISTEN </span><span class="si">#{</span><span class="no">RESET_CHANNEL</span><span class="si">}</span><span class="s2">"</span>
    <span class="n">conn</span><span class="p">.</span><span class="nf">async_exec</span> <span class="s2">"LISTEN </span><span class="si">#{</span><span class="no">CHANNEL</span><span class="si">}</span><span class="s2">"</span>
    <span class="kp">catch</span><span class="p">(</span><span class="ss">:break_loop</span><span class="p">)</span> <span class="k">do</span>
      <span class="kp">loop</span> <span class="k">do</span>
        <span class="n">conn</span><span class="p">.</span><span class="nf">wait_for_notify</span> <span class="k">do</span> <span class="o">|</span><span class="n">channel</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">payload</span><span class="o">|</span>
          <span class="nb">p</span> <span class="p">[</span><span class="n">channel</span><span class="p">,</span> <span class="n">payload</span><span class="p">]</span>
          <span class="kp">throw</span> <span class="ss">:break_loop</span> <span class="k">if</span> <span class="n">channel</span> <span class="o">==</span> <span class="no">RESET_CHANNEL</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">rescue</span> <span class="o">=&gt;</span> <span class="n">error</span>
    <span class="nb">p</span> <span class="p">[</span><span class="ss">:error</span><span class="p">,</span> <span class="n">error</span><span class="p">]</span>
  <span class="k">ensure</span>
    <span class="n">conn</span><span class="p">.</span><span class="nf">async_exec</span> <span class="s2">"UNLISTEN *"</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p><em>another-process.rb</em></p>
<pre class="highlight ruby"><code><span class="no">User</span><span class="p">.</span><span class="nf">connection</span><span class="p">.</span><span class="nf">execute</span> <span class="sx">%Q(NOTIFY "slack_bot", params)</span>
</code></pre>
</div><div class="article__tags"><a href="/topics/rails" class="article__tag">rails</a><a href="/topics/postgres" class="article__tag">postgres</a></div></div><div class="article"><h2 class="article__title"><a href="/show-opengraph-image-on-first-facebook-share/">Show Open Graph image on first Facebook&nbsp;share</a></h2><div class="article__meta">Max Wheeler, 02 September 2015</div><div class="article__content" data-view-highlight=""><p>When you share a URL on Facebook for the first time — specifically, the first time <em>anyone</em> has shared it — it won’t include any of the images on the page and our clients will be :cry:. This happens even if you have included a meta tag that references an image:</p>
<pre class="highlight html"><code><span class="nt">&lt;meta</span> <span class="na">property=</span><span class="s">"og:image"</span> <span class="na">content=</span><span class="s">"http://foo.com/image.png"</span><span class="nt">&gt;</span>
</code></pre>

<p>The <em>second</em> time a URL is shared, it’ll work as expected and your chosen <code>og:image</code> will show up in the share preview (along with any other images on the page) — Facebook seem to have shifted this all to a background job or something.</p>

<p>Fear not! There is a solution. If you include the dimensions of your image alongside the <code>og:image</code> meta tag it’ll force Facebook to show the image immediately:</p>
<pre class="highlight html"><code><span class="nt">&lt;meta</span> <span class="na">property=</span><span class="s">"og:image"</span> <span class="na">content=</span><span class="s">"http://foo.com/image.png"</span><span class="nt">&gt;</span>
<span class="nt">&lt;meta</span> <span class="na">property=</span><span class="s">"og:image:width"</span> <span class="na">content=</span><span class="s">"300"</span><span class="nt">&gt;</span>
<span class="nt">&lt;meta</span> <span class="na">property=</span><span class="s">"og:image:height"</span> <span class="na">content=</span><span class="s">"400"</span><span class="nt">&gt;</span>
</code></pre>

<p>These dimensions don’t actually have to be accurate either. On Readings we don’t know the dimensions of images as they’re provided by Erudite without any meta-information, so we do a best-guess approach based on the ratio that book covers (or CD covers) tend to be.</p>
</div><div class="article__tags"><a href="/topics/social" class="article__tag">social</a></div></div><div class="pagination"><a href="/" class="pagination__newer">&lsaquo; Newer</a><a href="/page/3/" class="pagination__older">Older &rsaquo;</a></div></div><div class="footer">A knowledgebase of little learnings from the team at Icelab. <a href="https://github.com/icelab/til/">Source on GitHub</a>.</div><script>!function(t){function e(i){if(n[i])return n[i].exports;var o=n[i]={exports:{},id:i,loaded:!1};return t[i].call(o.exports,o,o.exports,e),o.loaded=!0,o.exports}var n={};return e.m=t,e.c=n,e.p="",e(0)}([function(t,e,n){t.exports=n(10)},,,,,,,function(t,e){!function(){function e(t,e){r?t.addEventListener("scroll",e,!1):t.attachEvent("scroll",e)}function n(t){document.body?t():r?document.addEventListener("DOMContentLoaded",t):document.attachEvent("onreadystatechange",function(){"interactive"!=document.readyState&&"complete"!=document.readyState||t()})}function i(t){this.a=document.createElement("div"),this.a.setAttribute("aria-hidden","true"),this.a.appendChild(document.createTextNode(t)),this.b=document.createElement("span"),this.c=document.createElement("span"),this.h=document.createElement("span"),this.f=document.createElement("span"),this.g=-1,this.b.style.cssText="max-width:none;display:inline-block;position:absolute;height:100%;width:100%;overflow:scroll;font-size:16px;",this.c.style.cssText="max-width:none;display:inline-block;position:absolute;height:100%;width:100%;overflow:scroll;font-size:16px;",this.f.style.cssText="max-width:none;display:inline-block;position:absolute;height:100%;width:100%;overflow:scroll;font-size:16px;",this.h.style.cssText="display:inline-block;width:200%;height:200%;font-size:16px;max-width:none;",this.b.appendChild(this.h),this.c.appendChild(this.f),this.a.appendChild(this.b),this.a.appendChild(this.c)}function o(t,e){t.a.style.cssText="max-width:none;min-width:20px;min-height:20px;display:inline-block;overflow:hidden;position:absolute;width:auto;margin:0;padding:0;top:-999px;left:-999px;white-space:nowrap;font:"+e+";"}function a(t){var e=t.a.offsetWidth,n=e+100;return t.f.style.width=n+"px",t.c.scrollLeft=n,t.b.scrollLeft=t.b.scrollWidth+100,t.g!==e?(t.g=e,!0):!1}function l(t,n){function i(){var t=o;a(t)&&null!==t.a.parentNode&&n(t.g)}var o=t;e(t.b,i),e(t.c,i),a(t)}function s(t,e){var n=e||{};this.family=t,this.style=n.style||"normal",this.weight=n.weight||"normal",this.stretch=n.stretch||"normal"}function c(){if(null===f){var t=document.createElement("div");try{t.style.font="condensed 100px sans-serif"}catch(e){}f=""!==t.style.font}return f}function d(t,e){return[t.style,t.weight,c()?t.stretch:"","100px",e].join(" ")}var r=!!document.addEventListener,h=null,f=null,m=!!window.FontFace;s.prototype.load=function(t,e){var a=this,s=t||"BESbswy",c=e||3e3,r=(new Date).getTime();return new Promise(function(t,e){if(m){var f=new Promise(function(t,e){function n(){(new Date).getTime()-r>=c?e():document.fonts.load(d(a,a.family),s).then(function(e){1<=e.length?t():setTimeout(n,25)},function(){e()})}n()}),u=new Promise(function(t,e){setTimeout(e,c)});Promise.race([u,f]).then(function(){t(a)},function(){e(a)})}else n(function(){function n(){var e;(e=-1!=w&&-1!=y||-1!=w&&-1!=v||-1!=y&&-1!=v)&&((e=w!=y&&w!=v&&y!=v)||(null===h&&(e=/AppleWebKit\/([0-9]+)(?:\.([0-9]+))/.exec(window.navigator.userAgent),h=!!e&&(536>parseInt(e[1],10)||536===parseInt(e[1],10)&&11>=parseInt(e[2],10))),e=h&&(w==g&&y==g&&v==g||w==x&&y==x&&v==x||w==b&&y==b&&v==b)),e=!e),e&&(null!==T.parentNode&&T.parentNode.removeChild(T),clearTimeout(E),t(a))}function f(){if((new Date).getTime()-r>=c)null!==T.parentNode&&T.parentNode.removeChild(T),e(a);else{var t=document.hidden;!0!==t&&void 0!==t||(w=m.a.offsetWidth,y=u.a.offsetWidth,v=p.a.offsetWidth,n()),E=setTimeout(f,50)}}var m=new i(s),u=new i(s),p=new i(s),w=-1,y=-1,v=-1,g=-1,x=-1,b=-1,T=document.createElement("div"),E=0;T.dir="ltr",o(m,d(a,"sans-serif")),o(u,d(a,"serif")),o(p,d(a,"monospace")),T.appendChild(m.a),T.appendChild(u.a),T.appendChild(p.a),document.body.appendChild(T),g=m.a.offsetWidth,x=u.a.offsetWidth,b=p.a.offsetWidth,f(),l(m,function(t){w=t,n()}),o(m,d(a,'"'+a.family+'",sans-serif')),l(u,function(t){y=t,n()}),o(u,d(a,'"'+a.family+'",serif')),l(p,function(t){v=t,n()}),o(p,d(a,'"'+a.family+'",monospace'))})})},window.FontFaceObserver=s,window.FontFaceObserver.prototype.check=window.FontFaceObserver.prototype.load=s.prototype.load,"undefined"!=typeof t&&(t.exports=window.FontFaceObserver)}()},,function(t,e,n){function i(t){var e=window.localStorage.getItem("fontsLoaded");if(!e){var n=[];t.forEach(function(t){var e=new window.FontFaceObserver(t.family,{weight:t.weight,style:t.style});n.push(e.check())}),Promise.all(n).then(function(){window.document.documentElement.className+=" fonts-loaded",window.localStorage.setItem("fontsLoaded",!0)})}}n(7);var o=[{family:"National",style:"normal",weight:"normal"},{family:"National",style:"italic",weight:"normal"},{family:"National",style:"italic",weight:"bold"},{family:"National",style:"italic",weight:"bold"},{family:"TiemposText",style:"normal",weight:"normal"},{family:"TiemposText",style:"italic",weight:"normal"},{family:"TiemposText",style:"italic",weight:"bold"},{family:"TiemposText",style:"italic",weight:"bold"},{family:"Inconsolata",style:"normal",weight:"400"},{family:"Inconsolata",style:"italic",weight:"400"}];i(o)},function(t,e,n){n.p="/assets/",n(9)}]);</script></body></html>